<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Naver Login Proxy</title>
    <script>
        // Firebase Hostingì—ì„œ Functions í˜¸ì¶œ (CORS ì—†ìŒ)
        async function proxyNaverLogin(data) {
            console.log('ğŸ”¥ í”„ë¡ì‹œì—ì„œ í•¨ìˆ˜ í˜¸ì¶œ ì‹œì‘:', data);
            try {
                // Firebase Functions ì§ì ‘ í˜¸ì¶œ (ê°™ì€ í”„ë¡œì íŠ¸ì´ë¯€ë¡œ CORS ì—†ìŒ)
                const response = await fetch('https://asia-northeast3-ai-secretary-6e9c8.cloudfunctions.net/naverLoginHTTP', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                console.log('ğŸ“¡ Functions ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);
                console.log('ğŸ“¡ ì‘ë‹µ í—¤ë”:', [...response.headers.entries()]);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('âŒ HTTP ì˜¤ë¥˜ ì‘ë‹µ:', errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorText}`);
                }
                
                const responseText = await response.text();
                console.log('ğŸ“„ ì›ë³¸ ì‘ë‹µ í…ìŠ¤íŠ¸:', responseText.substring(0, 200) + '...');
                
                try {
                    const jsonResult = JSON.parse(responseText);
                    console.log('âœ… JSON íŒŒì‹± ì„±ê³µ:', jsonResult);
                    return jsonResult;
                } catch (parseError) {
                    console.error('âŒ JSON íŒŒì‹± ì‹¤íŒ¨:', parseError);
                    console.error('ğŸ“„ íŒŒì‹± ì‹¤íŒ¨í•œ ì‘ë‹µ:', responseText);
                    throw new Error(`JSON íŒŒì‹± ì˜¤ë¥˜: ${parseError.message}`);
                }
            } catch (error) {
                console.error('âŒ í”„ë¡ì‹œ ì˜¤ë¥˜:', error);
                throw error;
            }
        }

        function updateStatus(message, isError = false) {
            const statusEl = document.getElementById('status');
            if (statusEl) {
                statusEl.innerHTML = message;
                statusEl.style.color = isError ? '#ff4444' : '#333';
            }
        }

        // PostMessageë¥¼ í†µí•œ í†µì‹ 
        window.addEventListener('message', async (event) => {
            console.log('ğŸ“¨ í”„ë¡ì‹œì—ì„œ ë©”ì‹œì§€ ìˆ˜ì‹ :', event.origin, event.data);
            
            // cyberbrain.krì—ì„œ ì˜¨ ìš”ì²­ë§Œ ì²˜ë¦¬
            if (event.origin !== 'https://cyberbrain.kr') {
                console.log('âŒ í—ˆìš©ë˜ì§€ ì•Šì€ origin:', event.origin);
                return;
            }

            try {
                updateStatus('ë„¤ì´ë²„ ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘...');
                console.log('ğŸš€ í”„ë¡ì‹œ ë„¤ì´ë²„ ë¡œê·¸ì¸ ì‹œì‘');
                const result = await proxyNaverLogin(event.data);
                
                updateStatus('ë¡œê·¸ì¸ ì„±ê³µ! ì ì‹œ í›„ ì°½ì´ ë‹«í™ë‹ˆë‹¤...');
                console.log('âœ… í”„ë¡ì‹œ ë„¤ì´ë²„ ë¡œê·¸ì¸ ì„±ê³µ:', result);
                
                // ê²°ê³¼ë¥¼ ë‹¤ì‹œ cyberbrain.krë¡œ ì „ì†¡ (íŒì—… ë°©ì‹)
                if (window.opener) {
                    console.log('ğŸ“¤ ë¶€ëª¨ ì°½ì— ì„±ê³µ ê²°ê³¼ ì „ì†¡');
                    window.opener.postMessage({
                        type: 'naver-login-result',
                        success: true,
                        data: result
                    }, event.origin);
                }
                
                // 1ì´ˆ í›„ ìë™ìœ¼ë¡œ íŒì—… ë‹«ê¸°
                setTimeout(() => {
                    console.log('ğŸ”’ íŒì—… ì°½ ë‹«ê¸°');
                    window.close();
                }, 1000);
                
            } catch (error) {
                console.error('âŒ í”„ë¡ì‹œ ë„¤ì´ë²„ ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
                updateStatus(`ë¡œê·¸ì¸ ì˜¤ë¥˜: ${error.message}`, true);
                
                if (window.opener) {
                    console.log('ğŸ“¤ ë¶€ëª¨ ì°½ì— ì˜¤ë¥˜ ê²°ê³¼ ì „ì†¡');
                    window.opener.postMessage({
                        type: 'naver-login-result',
                        success: false,
                        error: error.message
                    }, event.origin);
                }
                
                // 3ì´ˆ í›„ ìë™ìœ¼ë¡œ íŒì—… ë‹«ê¸° (ì˜¤ë¥˜ì¸ ê²½ìš° ì¡°ê¸ˆ ë” ëŒ€ê¸°)
                setTimeout(() => {
                    console.log('ğŸ”’ íŒì—… ì°½ ë‹«ê¸° (ì˜¤ë¥˜)');
                    window.close();
                }, 3000);
            }
        });

        // ì¤€ë¹„ ì™„ë£Œ ì‹ í˜¸ (íŒì—… ë°©ì‹)
        console.log('ğŸ“‹ í”„ë¡ì‹œ ì´ˆê¸°í™” ì™„ë£Œ');
        if (window.opener) {
            console.log('ğŸ“¤ ë¶€ëª¨ ì°½ì— ì¤€ë¹„ ì™„ë£Œ ì‹ í˜¸ ì „ì†¡');
            window.opener.postMessage({
                type: 'proxy-ready'
            }, 'https://cyberbrain.kr');
        } else {
            console.log('âŒ ë¶€ëª¨ ì°½ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
        }
    </script>
</head>
<body>
    <div style="text-align: center; padding: 20px; font-family: Arial, sans-serif;">
        <h3>ë„¤ì´ë²„ ë¡œê·¸ì¸</h3>
        <p id="status">ì¸ì¦ ì²˜ë¦¬ ì¤€ë¹„ ì¤‘...</p>
        <div style="margin-top: 20px;">
            <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        </div>
    </div>
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</body>
</html>