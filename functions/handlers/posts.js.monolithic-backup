'use strict';

const { HttpsError, onCall } = require('firebase-functions/v2/https');
const { wrap } = require('../common/wrap');
const { httpWrap } = require('../common/http-wrap');
const { auth } = require('../common/auth');
const { admin, db } = require('../utils/firebaseAdmin');
const { callGenerativeModel } = require('../services/gemini');
const { fetchNaverNews, compressNewsWithAI, formatNewsForPrompt, shouldFetchNews } = require('../services/news-fetcher');
const { generateEnhancedMetadataHints } = require('../utils/enhanced-metadata-hints');
const { buildTitlePrompt } = require('../prompts/builders/title-generation');
const { buildSmartPrompt } = require('../prompts/prompts');

/**
 * ê³µë°± ì œì™¸ ê¸€ììˆ˜ ê³„ì‚° (Java ì½”ë“œì™€ ë™ì¼í•œ ë¡œì§)
 * @param {string} str - ê³„ì‚°í•  ë¬¸ìì—´
 * @returns {number} ê³µë°±ì„ ì œì™¸í•œ ê¸€ììˆ˜
 */
function countWithoutSpace(str) {
  if (!str) return 0;
  let count = 0;
  for (let i = 0; i < str.length; i++) {
    if (!/\s/.test(str.charAt(i))) { // ê³µë°± ë¬¸ìê°€ ì•„ë‹Œ ê²½ìš°
      count++;
    }
  }
  return count;
}

/**
 * Bio ë©”íƒ€ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ê°œì¸í™”ëœ ì›ê³  ì‘ì„± íŒíŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
 * @param {Object} bioMetadata - ì¶”ì¶œëœ ë°”ì´ì˜¤ê·¸ë˜í”¼ ë©”íƒ€ë°ì´í„°
 * @returns {string} ê°œì¸í™” íŒíŠ¸ ë¬¸ìì—´
 */
function generatePersonalizedHints(bioMetadata) {
  if (!bioMetadata) return '';

  const hints = [];

  // ì •ì¹˜ì  ì„±í–¥ ê¸°ë°˜ íŒíŠ¸
  if (bioMetadata.politicalStance?.progressive > 0.7) {
    hints.push('ë³´ìˆ˜ë³´ë‹¤ í˜ì‹ ì„ ê°•ì¡°í•˜ëŠ” ì§„ë³´ì  ê´€ì ìœ¼ë¡œ ì‘ì„±');
  } else if (bioMetadata.politicalStance?.conservative > 0.7) {
    hints.push('ì•ˆì •ì„±ê³¼ ì „í†µ ê°€ì¹˜ë¥¼ ì¤‘ì‹œí•˜ëŠ” ë³´ìˆ˜ì  ê´€ì ìœ¼ë¡œ ì‘ì„±');
  } else if (bioMetadata.politicalStance?.moderate > 0.8) {
    hints.push('ê· í˜•ì¡íŒ ì¤‘ë„ì  ê´€ì ì—ì„œ ë‹¤ì–‘í•œ ì˜ê²¬ì„ ìˆ˜ìš©í•˜ì—¬ ì‘ì„±');
  }

  // ì†Œí†µ ìŠ¤íƒ€ì¼ ê¸°ë°˜ íŒíŠ¸
  const commStyle = bioMetadata.communicationStyle;
  if (commStyle?.tone === 'warm') {
    hints.push('ë”°ëœ»í•˜ê³  ì¹œê·¼í•œ ì–´ì¡° ì‚¬ìš©');
  } else if (commStyle?.tone === 'formal') {
    hints.push('ê²©ì‹ìˆê³  ì „ë¬¸ì ì¸ ì–´ì¡° ì‚¬ìš©');
  }

  if (commStyle?.approach === 'inclusive') {
    hints.push('ëª¨ë“  ê³„ì¸µì„ í¬ìš©í•˜ëŠ” ìˆ˜ìš©ì  í‘œí˜„');
  } else if (commStyle?.approach === 'collaborative') {
    hints.push('í˜‘ë ¥ê³¼ ì†Œí†µì„ ê°•ì¡°í•˜ëŠ” í˜‘ì—…ì  í‘œí˜„');
  }

  // ì •ì±… ê´€ì‹¬ë„ ê¸°ë°˜ íŒíŠ¸
  const topPolicy = Object.entries(bioMetadata.policyFocus || {})
    .sort(([,a], [,b]) => b.weight - a.weight)[0];

  if (topPolicy && topPolicy[1].weight > 0.6) {
    const policyNames = {
      economy: 'ê²½ì œì •ì±…',
      education: 'êµìœ¡ì •ì±…',
      welfare: 'ë³µì§€ì •ì±…',
      environment: 'í™˜ê²½ì •ì±…',
      security: 'ì•ˆë³´ì •ì±…',
      culture: 'ë¬¸í™”ì •ì±…'
    };
    hints.push(`${policyNames[topPolicy[0]] || topPolicy[0]} ê´€ì ì—ì„œ í‘œí˜„`);
  }

  // ì§€ì—­ ì—°ê²°ì„± ê¸°ë°˜ íŒíŠ¸
  if (bioMetadata.localConnection?.strength > 0.8) {
    hints.push('ì§€ì—­í˜„ì•ˆê³¼ ì£¼ë¯¼ë“¤ì˜ ì‹¤ì œ ê²½í—˜ì„ êµ¬ì²´ì ìœ¼ë¡œ ë°˜ì˜');
    if (bioMetadata.localConnection.keywords?.length > 0) {
      hints.push(`ì§€ì—­ ìš©ì–´ ì‚¬ìš©: ${bioMetadata.localConnection.keywords.slice(0, 3).join(', ')}`);
    }
  }

  // ìƒì„± ì„ í˜¸ë„ ê¸°ë°˜ íŒíŠ¸
  const prefs = bioMetadata.generationProfile?.likelyPreferences;
  if (prefs?.includePersonalExperience > 0.8) {
    hints.push('ê°œì¸ì  ê²½í—˜ê³¼ ì‚¬ë¡€ë¥¼ í’ë¶€í•˜ê²Œ í¬í•¨');
  }
  if (prefs?.useStatistics > 0.7) {
    hints.push('êµ¬ì²´ì ì¸ ìˆ«ìì™€ ë°ì´í„°ë¥¼ ì ê·¹ì ìœ¼ë¡œ ì‚¬ìš©');
  }
  if (prefs?.focusOnFuture > 0.7) {
    hints.push('ë¯¸ë˜ ë¹„ì „ê³¼ ë°œì „ ë°©í–¥ì„ ì œì‹œ');
  }

  return hints.join(' | ');
}

/**
 * ì‚¬ìš©ì ê°œì¸ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í˜ë¥´ì†Œë‚˜ íŒíŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
 * @param {Object} userProfile - ì‚¬ìš©ì í”„ë¡œí•„ ì •ë³´
 * @param {string} category - ê¸€ ì¹´í…Œê³ ë¦¬
 * @param {string} topic - ê¸€ ì£¼ì œ
 * @returns {string} í˜ë¥´ì†Œë‚˜ íŒíŠ¸ ë¬¸ìì—´
 */
function generatePersonaHints(userProfile, category, topic) {
  if (!userProfile) return '';

  const hints = [];
  const topicLower = topic ? topic.toLowerCase() : '';

  // ì¹´í…Œê³ ë¦¬ë³„ ê´€ë ¨ë„ ë†’ì€ ì •ë³´ ìš°ì„  ì„ íƒ
  const relevantInfo = getRelevantPersonalInfo(userProfile, category, topicLower);

  // ì„ íƒëœ ì •ë³´ë§Œ ìì—°ìŠ¤ëŸ½ê²Œ êµ¬ì„±
  if (relevantInfo.age) {
    hints.push(relevantInfo.age);
  }

  if (relevantInfo.family) {
    hints.push(relevantInfo.family);
  }

  if (relevantInfo.background) {
    hints.push(relevantInfo.background);
  }

  if (relevantInfo.experience) {
    hints.push(relevantInfo.experience);
  }

  if (relevantInfo.committees && relevantInfo.committees.length > 0) {
    hints.push(`${relevantInfo.committees.join(', ')} í™œë™ ê²½í—˜ì„ ë°”íƒ•ìœ¼ë¡œ`);
  }

  if (relevantInfo.connection) {
    hints.push(relevantInfo.connection);
  }

  // X(íŠ¸ìœ„í„°) í”„ë¦¬ë¯¸ì—„ êµ¬ë… ì‹œì—ëŠ” SNS ë³¸ë¬¸ ê¸€ììˆ˜ ì œí•œ ì²´í¬ ì•ˆí•˜ë¯€ë¡œ í˜ë¥´ì†Œë‚˜ì— ë°˜ì˜ ì•ˆí•¨

  const persona = hints.filter(h => h).join(' ');
  return persona ? `[ì‘ì„± ê´€ì : ${persona}]` : '';
}

/**
 * ê¸€ ì¹´í…Œê³ ë¦¬ì™€ ì£¼ì œì— ë”°ë¼ ê´€ë ¨ì„± ë†’ì€ ê°œì¸ì •ë³´ë§Œ ì„ ë³„í•©ë‹ˆë‹¤
 */
function getRelevantPersonalInfo(userProfile, category, topicLower) {
  const result = {};

  // ë‚˜ì´ëŒ€ (ì¼ìƒ ì†Œí†µ, ê°€ì •/ìœ¡ì•„ ê´€ë ¨ ì£¼ì œì—ì„œ ê´€ë ¨ì„± ë†’ìŒ)
  if (category === 'daily-communication' ||
      topicLower.includes('family') || topicLower.includes('youth') || topicLower.includes('romance')) {
    if (userProfile.ageDecade) {
      result.age = userProfile.ageDetail ?
        `${userProfile.ageDecade} ${userProfile.ageDetail}` : userProfile.ageDecade;
    }
  }

  // ê°€ì • ìƒí™© (êµìœ¡, ë³µì§€, ì¼ìƒ ì†Œí†µì—ì„œ ê´€ë ¨ì„± ë†’ìŒ)
  if (category === 'daily-communication' ||
      topicLower.includes('êµìœ¡') || topicLower.includes('ìœ¡ì•„') || topicLower.includes('ë³µì§€')) {
    if (userProfile.familyStatus) {
      const familyMap = {
        'ì•„ì´ì—†ìŒ': 'ìë…€ê°€ ì—†ëŠ” ë¶€ëª¨ë¡œì„œ',
        'ìë…€ë™ë°˜': 'ìë…€ ì–‘ìœ¡ ê°€ì •ì˜ ê²½í—˜ì„ ê°€ì§„',
        'ê¸°í˜¼': 'ê°€ì •ì„ ê¾¸ë¦¬ë©°',
        'ë¯¸í˜¼': 'ì‹±ê¸€ íŒŒíŠ¸ë„ˆë¡œì„œ'
      };
      result.family = familyMap[userProfile.familyStatus];
    }
  }

  // ë°°ê²½ ê²½ë ¥ (ê´€ë ¨ ì •ì±… ë¶„ì•¼ì—ì„œ ê´€ë ¨ì„± ë†’ìŒ)
  if (userProfile.backgroundCareer) {
    const careerRelevance = {
      'êµìœ¡ì': ['êµìœ¡', 'í•™ìƒ', 'í•™êµ', 'êµì‚¬'],
      'ì‚¬ì—…ê°€': ['ê²½ì œ', 'ì¤‘ì†Œìƒê³µì¸', 'ì˜ì—…', 'ì°½ì—…'],
      'ê³µë¬´ì›': ['í–‰ì •', 'ì •ì±…', 'ê³µê³µì„œë¹„ìŠ¤'],
      'ì˜ë£Œì¸': ['ì˜ë£Œ', 'ê±´ê°•', 'ì½”ë¡œë‚˜', 'ë³´ê±´'],
      'ë²•ì¡°ì¸': ['ë²•', 'ì œë„', 'ì •ì˜', 'ê¶Œë¦¬']
    };

    const relevantKeywords = careerRelevance[userProfile.backgroundCareer] || [];
    const isRelevant = relevantKeywords.some(keyword => topicLower.includes(keyword));

    if (isRelevant) {
      result.background = `${userProfile.backgroundCareer} ì¶œì‹ ìœ¼ë¡œ`;
    }
  }

  // ì •ì¹˜ ê²½í—˜ (ì˜ì •í™œë™ ë³´ê³ , ì •ì±… ì œì•ˆì—ì„œ ê´€ë ¨ì„± ë†’ìŒ)
  if (category === 'activity-report' || category === 'policy-proposal') {
    if (userProfile.politicalExperience) {
      const expMap = {
        'ì´ˆì„ ': 'ì´ˆì„  ì˜ì›ìœ¼ë¡œì„œ ì‹ ì„ í•œ ê´€ì ì—ì„œ',
        'ì¬ì„ ': 'ì˜ì • ê²½í—˜ì„ ë°”íƒ•ìœ¼ë¡œ',
        '3ì„ ì´ìƒ': 'ë‹¤ì„  ì˜ì • ê²½í—˜ìœ¼ë¡œ',
        'ì •ì¹˜ ì‹ ì¸': 'ìƒˆë¡œìš´ ì‹œê°ì—ì„œ'
      };
      result.experience = expMap[userProfile.politicalExperience];
    }
  }

  // ì†Œì† ìœ„ì›íšŒ (ê´€ë ¨ ë¶„ì•¼ì—ì„œë§Œ ì–¸ê¸‰)
  if (userProfile.committees && userProfile.committees.length > 0) {
    const validCommittees = userProfile.committees.filter(c => c && c !== '');
    const relevantCommittees = validCommittees.filter(committee => {
      const committeeKeywords = {
        'êµìœ¡ìœ„ì›íšŒ': ['êµìœ¡', 'í•™ìƒ', 'í•™êµ', 'ëŒ€í•™'],
        'ë³´ê±´ë³µì§€ìœ„ì›íšŒ': ['ë³µì§€', 'ì˜ë£Œ', 'ê±´ê°•', 'ì—°ê¸ˆ'],
        'êµ­í† êµí†µìœ„ì›íšŒ': ['êµí†µ', 'ì£¼ê±°', 'ë„ë¡œ', 'ê±´ì„¤'],
        'í™˜ê²½ë…¸ë™ìœ„ì›íšŒ': ['í™˜ê²½', 'ë…¸ë™', 'ì¼ìë¦¬'],
        'ì—¬ì„±ê°€ì¡±ìœ„ì›íšŒ': ['ì—¬ì„±', 'ê°€ì¡±', 'ìœ¡ì•„', 'ì¶œì‚°']
      };

      const keywords = committeeKeywords[committee] || [];
      return keywords.some(keyword => topicLower.includes(keyword));
    });

    if (relevantCommittees.length > 0) {
      result.committees = relevantCommittees;
    }
  }

  // ì§€ì—­ ì—°ê³  (ì§€ì—­í˜„ì•ˆì—ì„œ ê´€ë ¨ì„± ë†’ìŒ)
  if (category === 'local-issues' || topicLower.includes('ì§€ì—­') || topicLower.includes('ìš°ë¦¬ ë™ë„¤')) {
    if (userProfile.localConnection) {
      const connectionMap = {
        'í† ë°•ì´': 'ì§€ì—­ í† ë°•ì´ë¡œì„œ',
        'ì˜¤ë˜ ê±°ì£¼': 'ì˜¤ë«ë™ì•ˆ ì´ ì§€ì—­ì— ê±°ì£¼í•´',
        'ì´ì£¼ë¯¼': 'ì´ ì§€ì—­ì—ì„œ ìƒˆë¡œìš´ ì‚¶ì„ ì‹œì‘í•œ ê³ í–¥ìœ¼ë¡œ ì¼êµ¬',
        'ê·€ë†': 'ê³ í–¥ìœ¼ë¡œ ëŒì•„ì˜¨'
      };
      result.connection = connectionMap[userProfile.localConnection];
    }
  }

  return result;
}

// ê°„ë‹¨í•œ ì‘ë‹µ í—¬í¼
const ok = (data) => ({ success: true, ...data });
const okMessage = (message) => ({ success: true, message });

// ì‚¬ìš©ì í¬ìŠ¤íŠ¸ ëª©ë¡ ì¡°íšŒ
exports.getUserPosts = wrap(async (req) => {
  const { uid } = await auth(req);
  console.log('POST getUserPosts ì‹œì‘:', { userId: uid });

  try {
    const postsSnapshot = await db.collection('posts')
      .where('userId', '==', uid)
      .orderBy('createdAt', 'desc')
      .limit(50)
      .get();

    const posts = [];
    postsSnapshot.forEach(doc => {
      const data = doc.data();
      // draft ìƒíƒœê°€ ì•„ë‹Œ í¬ìŠ¤íŠ¸ë§Œ í¬í•¨ (í´ë¼ì´ì–¸íŠ¸ í•„í„°ë§)
      if (data.status !== 'draft') {
        posts.push({
          id: doc.id,
          ...data,
          createdAt: data.createdAt?.toDate?.()?.toISOString() || null,
          updatedAt: data.updatedAt?.toDate?.()?.toISOString() || null
        });
      }
    });

    console.log('POST getUserPosts ì™„ë£Œ:', { count: posts.length });
    return ok({ posts });
  } catch (error) {
    console.error('POST getUserPosts ì˜¤ë¥˜:', error.message);
    throw new HttpsError('internal', 'í¬ìŠ¤íŠ¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
});

// íŠ¹ì • í¬ìŠ¤íŠ¸ ì¡°íšŒ
exports.getPost = wrap(async (req) => {
  const { uid } = await auth(req);
  const { postId } = req.data || {};
  console.log('POST getPost ì‹œì‘:', { userId: uid, postId });

  if (!postId) {
    throw new HttpsError('invalid-argument', 'í¬ìŠ¤íŠ¸ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
  }

  try {
    const postDoc = await db.collection('posts').doc(postId).get();
    if (!postDoc.exists) {
      throw new HttpsError('not-found', 'í¬ìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    const data = postDoc.data();
    if (data.userId !== uid) {
      throw new HttpsError('permission-denied', 'í¬ìŠ¤íŠ¸ë¥¼ ì¡°íšŒí•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
    }

    const post = {
      id: postDoc.id,
      ...data,
      createdAt: data.createdAt?.toDate?.()?.toISOString() || null,
      updatedAt: data.updatedAt?.toDate?.()?.toISOString() || null
    };

    console.log('POST getPost ì™„ë£Œ:', postId);
    return ok({ post });
  } catch (error) {
    if (error.code) throw error;
    console.error('POST getPost ì˜¤ë¥˜:', error.message);
    throw new HttpsError('internal', 'í¬ìŠ¤íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
});

// í¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
exports.updatePost = wrap(async (req) => {
  const { uid } = await auth(req);
  const { postId, updates } = req.data || {};
  console.log('POST updatePost ì‹œì‘:', { userId: uid, postId });

  if (!postId || !updates) {
    throw new HttpsError('invalid-argument', 'í¬ìŠ¤íŠ¸ IDì™€ ìˆ˜ì • ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
  }

  try {
    const postDoc = await db.collection('posts').doc(postId).get();
    if (!postDoc.exists) {
      throw new HttpsError('not-found', 'í¬ìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    const current = postDoc.data() || {};
    if (current.userId !== uid) {
      throw new HttpsError('permission-denied', 'í¬ìŠ¤íŠ¸ë¥¼ ìˆ˜ì •í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
    }

    const allowed = ['title', 'content', 'category', 'subCategory', 'keywords', 'status'];
    const sanitized = {};
    for (const k of allowed) {
      if (updates[k] !== undefined) sanitized[k] = updates[k];
    }

    if (sanitized.content) {
      sanitized.wordCount = String(sanitized.content).replace(/<[^>]*>/g, '').replace(/\s/g, '').length;
    }
    sanitized.updatedAt = admin.firestore.FieldValue.serverTimestamp();

    await db.collection('posts').doc(postId).update(sanitized);
    console.log('POST updatePost ì™„ë£Œ:', postId);
    return okMessage('í¬ìŠ¤íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
  } catch (error) {
    if (error.code) throw error;
    console.error('POST updatePost ì˜¤ë¥˜:', error.message);
    throw new HttpsError('internal', 'í¬ìŠ¤íŠ¸ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
});

// í¬ìŠ¤íŠ¸ ì‚­ì œ
exports.deletePost = wrap(async (req) => {
  const { uid } = await auth(req);
  const { postId } = req.data || {};
  console.log('POST deletePost ì‹œì‘:', { userId: uid, postId });

  if (!postId) {
    throw new HttpsError('invalid-argument', 'í¬ìŠ¤íŠ¸ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
  }

  try {
    const postDoc = await db.collection('posts').doc(postId).get();
    if (!postDoc.exists) {
      throw new HttpsError('not-found', 'í¬ìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    const data = postDoc.data() || {};
    if (data.userId !== uid) {
      throw new HttpsError('permission-denied', 'í¬ìŠ¤íŠ¸ë¥¼ ì‚­ì œí•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
    }

    await db.collection('posts').doc(postId).delete();
    console.log('POST deletePost ì™„ë£Œ:', postId);
    return okMessage('í¬ìŠ¤íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
  } catch (error) {
    if (error.code) throw error;
    console.error('POST deletePost ì˜¤ë¥˜:', error.message);
    throw new HttpsError('internal', 'í¬ìŠ¤íŠ¸ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
});

// ì‚¬ìš©ëŸ‰ ì œí•œ ì²´í¬
exports.checkUsageLimit = wrap(async (req) => {
  const { uid } = await auth(req);
  console.log('USAGE checkUsageLimit ì‹œì‘:', { userId: uid });

  try {
    const now = new Date();
    const thisMonth = new Date(now.getFullYear(), now.getMonth(), 1);

    const snap = await db.collection('posts')
      .where('userId', '==', uid)
      .where('createdAt', '>=', admin.firestore.Timestamp.fromDate(thisMonth))
      .get();

    const used = snap.size;
    const limit = 50;

    console.log('USAGE checkUsageLimit ì™„ë£Œ:', { used, limit });
    return ok({
      postsGenerated: used,
      monthlyLimit: limit,
      canGenerate: used < limit,
      remainingPosts: Math.max(0, limit - used),
    });
  } catch (error) {
    console.error('USAGE ì˜¤ë¥˜:', error.message);
    if (error.code === 'failed-precondition') {
      return ok({
        postsGenerated: 0,
        monthlyLimit: 50,
        canGenerate: true,
        remainingPosts: 50
      });
    }
    throw new HttpsError('internal', 'ì‚¬ìš©ëŸ‰ì„ í™•ì¸í•˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
});

// ì§„ì§œ AI ì›ê³  ìƒì„± í•¨ìˆ˜ (ë°±ì—…ì—ì„œ ë³µêµ¬) - HTTP ë²„ì „

/**
 * ë³¸ë¬¸ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ì œëª©ì„ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
 * @param {Object} params - ì œëª© ìƒì„±ì— í•„ìš”í•œ íŒŒë¼ë¯¸í„°
 * @param {string} params.content - ìƒì„±ëœ ë³¸ë¬¸ ë‚´ìš©
 * @param {string|Array} params.backgroundInfo - ë°°ê²½ì •ë³´
 * @param {Array} params.keywords - í‚¤ì›Œë“œ ëª©ë¡
 * @param {string} params.topic - ì£¼ì œ
 * @param {string} params.fullName - ì‘ì„±ì ì´ë¦„
 * @param {string} params.modelName - ì‚¬ìš©í•  AI ëª¨ë¸ëª…
 * @returns {Promise<string>} - ìƒì„±ëœ ì œëª©
 */
async function generateTitleFromContent({ content, backgroundInfo, keywords, topic, fullName, modelName }) {
  console.log('ğŸ“ 2ë‹¨ê³„: ë³¸ë¬¸ ê¸°ë°˜ ì œëª© ìƒì„± ì‹œì‘');

  // ë³¸ë¬¸ì—ì„œ HTML íƒœê·¸ ì œê±°í•˜ê³  ë¯¸ë¦¬ë³´ê¸° ì¶”ì¶œ
  const contentPreview = content.substring(0, 1000).replace(/<[^>]*>/g, '');

  // ë°°ê²½ì •ë³´ í…ìŠ¤íŠ¸ ì¶”ì¶œ
  const backgroundText = Array.isArray(backgroundInfo)
    ? backgroundInfo.filter(item => item && item.trim()).join('\n')
    : backgroundInfo || '';

  // ë¶„ë¦¬ëœ í”„ë¡¬í”„íŠ¸ ë¹Œë” ì‚¬ìš©
  const titlePrompt = buildTitlePrompt({
    contentPreview,
    backgroundText,
    topic,
    fullName,
    keywords
  });

  try {
    const titleResponse = await callGenerativeModel(titlePrompt, 1, modelName);

    // JSONì´ë‚˜ ì½”ë“œ ë¸”ë¡ ì œê±°
    let cleanTitle = titleResponse
      .replace(/```json/g, '')
      .replace(/```/g, '')
      .trim();

    // ì²« ë²ˆì§¸ ì¤„ë§Œ ì¶”ì¶œ (ì—¬ëŸ¬ ì¤„ì¸ ê²½ìš°)
    cleanTitle = cleanTitle.split('\n')[0].trim();

    // ë”°ì˜´í‘œ ì œê±°
    cleanTitle = cleanTitle.replace(/^["']|["']$/g, '');

    console.log('âœ… ì œëª© ìƒì„± ì™„ë£Œ:', cleanTitle);
    return cleanTitle;
  } catch (error) {
    console.error('âŒ ì œëª© ìƒì„± ì‹¤íŒ¨:', error.message);
    // ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ì œëª© ë°˜í™˜
    return `${topic} ê´€ë ¨ ì›ê³ `;
  }
}


exports.generatePosts = httpWrap(async (req) => {
  console.log('ğŸ”¥ generatePosts HTTP ì‹œì‘');

  let uid;
  let decodedToken = null;

  // ë°ì´í„° ì¶”ì¶œ - Firebase SDKì™€ HTTP ìš”ì²­ ëª¨ë‘ ì²˜ë¦¬
  let requestData = req.data || req.rawRequest?.body || {};

  // ì¤‘ì²©ëœ data êµ¬ì¡° ì²˜ë¦¬ (Firebase SDKì—ì„œ {data: {ì‹¤ì œë°ì´í„°}} í˜•íƒœë¡œ ë³´ë‚¼ ë•Œ)
  if (requestData.data && typeof requestData.data === 'object') {
    requestData = requestData.data;
  }

  // ì‚¬ìš©ì ì¸ì¦ ë°ì´í„° í™•ì¸ (ëª¨ë“  ì‚¬ìš©ìëŠ” ë„¤ì´ë²„ ë¡œê·¸ì¸)
  if (requestData.__naverAuth && requestData.__naverAuth.uid && requestData.__naverAuth.provider === 'naver') {
    console.log('ğŸ“± ì‚¬ìš©ì ì¸ì¦ ì²˜ë¦¬:', requestData.__naverAuth.uid);
    uid = requestData.__naverAuth.uid;
    // ì¸ì¦ ì •ë³´ ì œê±° (ì²˜ë¦¬ ì™„ë£Œ)
    delete requestData.__naverAuth;
  } else {
    const authHeader = (req.rawRequest && (req.rawRequest.headers.authorization || req.rawRequest.headers.Authorization)) || '';
    if (authHeader && authHeader.startsWith('Bearer ')) {
      const idToken = authHeader.split('Bearer ')[1];
      try {
        const verified = await admin.auth().verifyIdToken(idToken);
        uid = verified.uid;
      } catch (authError) {
        console.error('ID token verify failed:', authError);
        throw new HttpsError('unauthenticated', 'ìœ íš¨í•˜ì§€ ì•Šì€ ì¸ì¦ í† í°ì…ë‹ˆë‹¤.');
      }
    } else {
      console.error('ì¸ì¦ ì •ë³´ ëˆ„ë½:', requestData);
      throw new HttpsError('unauthenticated', 'ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.');
    }
  }

  console.log('âœ… ì‚¬ìš©ì ì¸ì¦ ì™„ë£Œ:', uid);

  console.log('ğŸ” ì „ì²´ ìš”ì²­ êµ¬ì¡°:', JSON.stringify({
    data: req.data,
    body: req.rawRequest?.body,
    method: req.rawRequest?.method,
    headers: req.rawRequest?.headers
  }, null, 2));

  // ë°ì´í„°ëŠ” ì´ë¯¸ ìœ„ì—ì„œ ì¶”ì¶œí–ˆìœ¼ë¯€ë¡œ requestData ë³€ìˆ˜ ì‚¬ìš©
  const useBonus = requestData?.useBonus || false;

  // ì´ì œ dataë¥¼ requestDataë¡œ í• ë‹¹
  const data = requestData;

  console.log('ğŸ”¥ generatePosts ì‹œì‘ (ì‹¤ì œ AI ìƒì„±) - ë°›ì€ ë°ì´í„°', JSON.stringify(data, null, 2));

  // prompt í•„ë“œ ìš°ì„  ì²˜ë¦¬
  const topic = data.prompt || data.topic || '';
  const category = data.category || '';
  const modelName = data.modelName || 'gemini-2.0-flash-exp'; // ê¸°ë³¸ê°’ì€ 2.0-flash (JSON mode ì§€ì›)
  const targetWordCount = data.wordCount || 1700; // ì‚¬ìš©ì ìš”ì²­ ê¸€ììˆ˜ (ê¸°ë³¸ê°’ 1700)

  console.log('ğŸ” ê²€ì¦ ì¤‘', {
    topic: topic ? topic.substring(0, 50) : topic,
    category,
    modelName,
    rawPrompt: data.prompt,
    rawTopic: data.topic,
    fullTopic: topic
  });
  if (!topic || typeof topic !== 'string' || topic.trim().length === 0) {
    console.error('âŒ ì£¼ì œ ê²€ì¦ ì‹¤íŒ¨:', { topic, type: typeof topic });
    throw new HttpsError('invalid-argument', 'ì£¼ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
  }

  if (!category || typeof category !== 'string' || category.trim().length === 0) {
    console.error('âŒ ì¹´í…Œê³ ë¦¬ ê²€ì¦ ì‹¤íŒ¨:', { category, type: typeof category });
    throw new HttpsError('invalid-argument', 'ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
  }

  console.log(`âœ… ë°ì´í„° ê²€ì¦ í†µê³¼: ì£¼ì œ="${topic.substring(0, 50)}..." ì¹´í…Œê³ ë¦¬="${category}"`);

  try {
    // ì‚¬ìš©ì í”„ë¡œí•„ ë° Bio ë©”íƒ€ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    let userProfile = {};
    let bioMetadata = null;
    let personalizedHints = '';
    let dailyLimitWarning = false;
    let userMetadata = null; // í–¥ìƒëœ ë©”íƒ€ë°ì´í„° (ìŠ¤ì½”í”„ ë²„ê·¸ ìˆ˜ì •)

    try {
      // ì‚¬ìš©ì ê¸°ë³¸ ì •ë³´ ì¡°íšŒ
      console.log(`ğŸ” í”„ë¡œí•„ ì¡°íšŒ ì‹œë„ - UID: ${uid}, ê¸¸ì´: ${uid?.length}`);
      const userDoc = await Promise.race([
        db.collection('users').doc(uid).get(),
        new Promise((_, reject) => setTimeout(() => reject(new Error('í”„ë¡œí•„ ì¡°íšŒ íƒ€ì„ì•„ì›ƒ')), 5000))
      ]);

      console.log(`ğŸ“‹ í”„ë¡œí•„ ë¬¸ì„œ ì¡´ì¬ ì—¬ë¶€: ${userDoc.exists}`);
      if (userDoc.exists) {
        userProfile = userDoc.data();
        console.log('âœ… ì‚¬ìš©ì í”„ë¡œí•„ ì¡°íšŒ ì™„ë£Œ:', userProfile.name || 'Unknown');

        // í•˜ë£¨ ìƒì„±ëŸ‰ ì œí•œ í™•ì¸ (ê´€ë¦¬ìëŠ” ì œí•œ ì—†ìŒ)
        const isAdmin = userProfile.isAdmin === true;

        if (!isAdmin) {
          // ì¼ë°˜ ì‚¬ìš©ì í•˜ë£¨ 3íšŒ ì´ˆê³¼ ì‹œ ê²½ê³  (ì°¨ë‹¨í•˜ì§€ëŠ” ì•ŠìŒ)
          const today = new Date();
          const todayKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
          const dailyUsage = userProfile.dailyUsage || {};
          const todayGenerated = dailyUsage[todayKey] || 0;

          if (todayGenerated >= 3) {
            console.log('âš ï¸ í•˜ë£¨ 3íšŒ ì´ˆê³¼ ìƒì„± - ê²½ê³ ë§Œ í‘œì‹œ');
            dailyLimitWarning = true;
            // ì°¨ë‹¨í•˜ì§€ ì•Šê³  ê³„ì† ì§„í–‰ (ê²½ê³  ë©”ì‹œì§€ë§Œ ì‘ë‹µì— í¬í•¨)
          }

          console.log('âœ… ì¼ë°˜ ì‚¬ìš©ì í•˜ë£¨ ì‚¬ìš©ëŸ‰ í™•ì¸:', { todayGenerated, warning: todayGenerated >= 3 });
        } else {
          console.log('âœ… ê´€ë¦¬ì ê³„ì • - í•˜ë£¨ ìƒì„±ëŸ‰ ì œí•œ ë¬´ì‹œ');
        }

        // ë³´ë„ˆìŠ¤ ì‚¬ìš© ì—¬ë¶€ì— ë”°ë¥¸ ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
        if (useBonus) {
          const usage = userProfile.usage || { bonusGenerated: 0, bonusUsed: 0 };
          const availableBonus = Math.max(0, usage.bonusGenerated - (usage.bonusUsed || 0));

          if (availableBonus <= 0) {
            throw new HttpsError('failed-precondition', 'ì‚¬ìš© ê°€ëŠ¥í•œ ë³´ë„ˆìŠ¤ ì›ê³ ê°€ ì—†ìŠµë‹ˆë‹¤.');
          }

          console.log('âœ… ë³´ë„ˆìŠ¤ ì›ê³  ì‚¬ìš© ê°€ëŠ¥', { availableBonus });
        } else {
          // ì¼ë°˜ ì‚¬ìš©ëŸ‰ í™•ì¸ (ê´€ë¦¬ìëŠ” ì œí•œ ì—†ìŒ)
          if (!isAdmin) {
            const usage = userProfile.usage || { postsGenerated: 0, monthlyLimit: 50 };

            if (usage.postsGenerated >= usage.monthlyLimit) {
              throw new HttpsError('resource-exhausted', 'ì›”ê°„ ìƒì„± ì‹œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.');
            }

            console.log('âœ… ì¼ë°˜ ì›ê³  ìƒì„± ê°€ëŠ¥', {
              current: usage.postsGenerated,
              limit: usage.monthlyLimit
            });
          } else {
            console.log('âœ… ê´€ë¦¬ì ê³„ì • - ì›”ê°„ ìƒì„±ëŸ‰ ì œí•œ ë¬´ì‹œ');
          }
        }
      }

      // Bio ë©”íƒ€ë°ì´í„° ì¡°íšŒ (ì„ íƒì )
      console.log(`ğŸ” Bio ë©”íƒ€ë°ì´í„° ì¡°íšŒ ì‹œë„ - UID: ${uid}`);
      const bioDoc = await db.collection('bios').doc(uid).get();
      console.log(`ğŸ“‹ Bio ë¬¸ì„œ ì¡´ì¬ ì—¬ë¶€: ${bioDoc.exists}`);
      if (bioDoc.exists && bioDoc.data().extractedMetadata) {
        bioMetadata = bioDoc.data().extractedMetadata;

        // ë©”íƒ€ë°ì´í„° ê¸°ë°˜ ê°œì¸í™” íŒíŠ¸ ìƒì„±
        personalizedHints = generatePersonalizedHints(bioMetadata);
        console.log('âœ… Bio ë©”íƒ€ë°ì´í„° ì‚¬ìš©:', Object.keys(bioMetadata));

        // Bio ì‚¬ìš© í†µê³„ ì—…ë°ì´íŠ¸
        await db.collection('bios').doc(uid).update({
          'usage.generatedPostsCount': admin.firestore.FieldValue.increment(1),
          'usage.lastUsedAt': admin.firestore.FieldValue.serverTimestamp()
        });
      }

      // ê°œì¸ì •ë³´ ê¸°ë°˜ í˜ë¥´ì†Œë‚˜ íŒíŠ¸ ìƒì„± ë° ì¶”ê°€
      const personaHints = generatePersonaHints(userProfile, category, topic);
      if (personaHints) {
        personalizedHints = personalizedHints ? `${personalizedHints} | ${personaHints}` : personaHints;
        console.log('âœ… í˜ë¥´ì†Œë‚˜ íŒíŠ¸ ì¶”ê°€:', personaHints);
      }

      // Bio ë©”íƒ€ë°ì´í„° ë¡œë“œ (í–¥ìƒëœ ê°œì¸í™”ë¥¼ ìœ„í•´)
      try {
        const bioDoc = await db.collection('bios').doc(uid).get();

        if (bioDoc.exists && bioDoc.data().metadataStatus === 'completed') {
          const bioData = bioDoc.data();

          userMetadata = {
            extractedMetadata: bioData.extractedMetadata,
            typeMetadata: bioData.typeMetadata?.[category],
            hints: bioData.optimizationHints
          };

          console.log('âœ… í–¥ìƒëœ ë©”íƒ€ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', uid);
        }
      } catch (metaError) {
        console.warn('âš ï¸ ë©”íƒ€ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ (ë¬´ì‹œí•˜ê³  ê³„ì†):', metaError.message);
      }

      // í–¥ìƒëœ ë©”íƒ€ë°ì´í„° íŒíŠ¸ ì¶”ê°€
      const enhancedHints = generateEnhancedMetadataHints(userMetadata, category);
      if (enhancedHints) {
        personalizedHints = personalizedHints ? `${personalizedHints} | ${enhancedHints}` : enhancedHints;
        console.log('âœ… í–¥ìƒëœ ë©”íƒ€ë°ì´í„° íŒíŠ¸ ì¶”ê°€:', enhancedHints);
      }

    } catch (profileError) {
      console.error('âŒ í”„ë¡œí•„/Bio ì¡°íšŒ ì‹¤íŒ¨:', {
        error: profileError.message,
        stack: profileError.stack,
        uid: uid,
        uidType: typeof uid,
        uidLength: uid?.length
      });

      // í”„ë¡œí•„ì´ ì—†ì–´ë„ ê³„ì† ì§„í–‰ (ê¸°ë³¸ê°’ ì‚¬ìš©)
      throw new HttpsError('internal', `í”„ë¡œí•„ ì¡°íšŒ ì‹¤íŒ¨: ${profileError.message}`);
    }

    // ì‚¬ìš©ì ìƒíƒœì— ë”°ë¥¸ ê¸€ ì„¤ì • ë° í˜¸ì¹­ ê²°ì •
    const statusConfig = {
      'í˜„ì—­': {
        guideline: 'í˜„ì—­ ì˜ì›ìœ¼ë¡œì„œ ê²½í—˜ê³¼ ì„±ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‹ ë¢°ìˆëŠ” ë‚´ìš©ì„ í¬í•¨í•˜ì„¸ìš”. ì‹¤ì œ ì˜ì •í™œë™ ê²½í—˜ì„ ì–¸ê¸‰í•˜ëŠ”ê²Œ ì¢‹ìŠµë‹ˆë‹¤.',
        title: userProfile.position || 'ì˜ì›'
      },
      'ì˜ˆë¹„': {
        guideline: 'ì˜ˆë¹„í›„ë³´ë¡œì„œ ì •ì±…ê³¼ ê³µì•½ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì‹ ë¢°ìˆëŠ” ë‚´ìš©ì„ ì‘ì„±í•˜ì„¸ìš”. ë¯¸ë˜ ë¹„ì „ê³¼ êµ¬ì²´ì  ê³„íšì„ ì œì‹œí•˜ì„¸ìš”',
        title: `${userProfile.position || ''}ì˜ˆë¹„í›„ë³´`.replace('ì˜ì›ì˜ˆë¹„í›„ë³´', 'ì˜ˆë¹„í›„ë³´')
      },
      'ì€í‡´': {
        guideline: 'ì€í‡´ ìƒíƒœì—ì„œëŠ” ì–´ë–¤ í˜¸ì¹­ë„ ì‚¬ìš©í•˜ì§€ ì•Šê³  ê°œì¸ ì´ë¦„ìœ¼ë¡œë§Œ ì§€ì¹­í•˜ì„¸ìš”. í˜„ìƒ ì§„ë‹¨ê³¼ ê°œì¸ì  ê²¬í•´ë§Œ í‘œí˜„í•˜ì„¸ìš”. ì ˆëŒ€ "ì€í‡´ì˜ˆë¹„í›„ë³´", "ì˜ˆë¹„í›„ë³´", "ì˜ì›", "í˜„ì—­ ì˜ì›ìœ¼ë¡œì„œ", "ì˜ì •í™œë™", "ì„±ê³¼", "ì‹¤ì ", "ì¶”ì§„í•¨", "ê¸°ì—¬í•¨" ê°™ì€ í‘œí˜„ì„ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”. êµ¬ì²´ì ì¸ ë¹„ì „ì´ë‚˜ ê³„íšì„ ì–¸ê¸‰í•˜ì§€ ë§ˆì„¸ìš”. ì˜¤ì§ í˜„ ìƒí™©ì— ëŒ€í•œ ê°œì¸ì  ê²½í—˜ê³¼ ì§„ë‹¨ë§Œ í‘œí˜„í•˜ì„¸ìš”',
        title: '' // ì€í‡´ ìƒíƒœì—ì„œëŠ” í˜¸ì¹­ ì—†ìŒ
      }
    };

    const currentStatus = userProfile.status || 'í˜„ì—­';
    const config = statusConfig[currentStatus] || statusConfig['í˜„ì—­'];

    // í”„ë¡¬í”„íŠ¸ ìƒì„±
    const fullName = userProfile.name || 'ì‚¬ìš©ì';
    // ìì—°ìŠ¤ëŸ¬ìš´ ì§€ì—­ëª… í˜¸ì¹­ ìƒì„± (ëª¨ë‘ ë¶™ì—¬ì“°ê¸°)
    const generateNaturalRegionTitle = (regionLocal, regionMetro) => {
      // ê¸°ë³¸ ì§€ì—­ì´ ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´
      if (!regionLocal && !regionMetro) return '';

      // ìš°ì„ ìˆœìœ„: regionLocal > regionMetro
      const primaryRegion = regionLocal || regionMetro;

      // ê´‘ì—­ì‹œ ë‹¨ìœ„: XXê´‘ì—­ì‹œ, XXêµ¬ë„
      if (primaryRegion.includes('ê´‘ì—­ì‹œ') || primaryRegion.includes('êµ¬ë„')) {
        return primaryRegion + 'ë¯¼';
      }

      // ë„ ë‹¨ìœ„: XXë„
      if (primaryRegion.includes('ë„')) {
        return primaryRegion + 'ë¯¼';
      }

      // ì‹œ ë‹¨ìœ„: XXì‹œ
      if (primaryRegion.includes('ì‹œ')) {
        return primaryRegion + 'ë¯¼';
      }

      // ê¸°íƒ€ì¸ ê²½ìš° ê¸°ë³¸ìœ¼ë¡œ ì²˜ë¦¬
      return primaryRegion + 'ë„ë¯¼';
    };

    const fullRegion = generateNaturalRegionTitle(userProfile.regionLocal, userProfile.regionMetro);


    // ë‰´ìŠ¤ ì»¨í…ìŠ¤íŠ¸ ì¡°íšŒ (ì‹œì‚¬ë¹„í‰, ì •ì±…ì œì•ˆ ë“± íŠ¹ì • ì¹´í…Œê³ ë¦¬ë§Œ) - AI ì••ì¶• ì ìš©
    let newsContext = '';
    if (shouldFetchNews(category)) {
      try {
        console.log('ğŸ“° ë‰´ìŠ¤ ì»¨í…ìŠ¤íŠ¸ ì¡°íšŒ ì‹œì‘:', topic);
        const news = await fetchNaverNews(topic, 3);
        if (news && news.length > 0) {
          // AI ì••ì¶• ì ìš© (í† í° 80% ì ˆê°)
          const compressedNews = await compressNewsWithAI(news);
          newsContext = formatNewsForPrompt(compressedNews);
          console.log(`âœ… ë‰´ìŠ¤ ${news.length}ê°œ ì••ì¶• ì™„ë£Œ`);
        }
      } catch (newsError) {
        console.warn('âš ï¸ ë‰´ìŠ¤ ì¡°íšŒ ì‹¤íŒ¨ (ë¬´ì‹œí•˜ê³  ê³„ì†):', newsError.message);
        // ë‰´ìŠ¤ ì¡°íšŒ ì‹¤íŒ¨í•´ë„ ì›ê³  ìƒì„±ì€ ê³„ì† ì§„í–‰
      }
    }


    // ë°°ê²½ì •ë³´ì—ì„œ í•„ìˆ˜ í‚¤ì›Œë“œ ì¶”ì¶œ (ê²€ì¦ìš©)
    function extractKeywordsFromInstructions(instructions) {
      if (!instructions) return [];

      const text = Array.isArray(instructions) ? instructions.join(' ') : instructions;
      const keywords = [];

      // 1. ìˆ«ì+ë‹¨ìœ„ ì¶”ì¶œ (ì˜ˆ: 300ì—¬ëª…, 500ëª…, 1000ê°œ, 2íšŒ)
      const numberMatches = text.match(/[0-9]+ì—¬?[ëª…ê°œíšŒê±´ì°¨ëª…ì›”ì¼ë…„ì›]/g);
      if (numberMatches) keywords.push(...numberMatches);

      // 2. ì¸ëª… + ì§ì±… íŒ¨í„´ (ì˜ˆ: í™ê¸¸ë™ ì˜ì›, ê¹€ì² ìˆ˜ ìœ„ì›ì¥, í™ê¸¸ë™ ê²½ê¸°ë„ë‹¹ìœ„ì›ì¥)
      // ì²« ë²ˆì§¸ íŒ¨í„´: ì§ì±…ì´ ë°”ë¡œ ë¶™ê±°ë‚˜ ê³µë°± í›„ ë‚˜ì˜¤ëŠ” ê²½ìš°
      const nameWithTitleMatches = text.match(/[ê°€-í£]{2,4}\s+(?:ê²½ê¸°ë„ë‹¹ìœ„ì›ì¥|êµ­íšŒì˜ì›|ìœ„ì›ì¥|ì˜ì›|ì‹œì¥|ë„ì§€ì‚¬|ì¥ê´€|ì´ë¦¬|ëŒ€í†µë ¹)/g);
      if (nameWithTitleMatches) {
        keywords.push(...nameWithTitleMatches);
        // ì´ë¦„ë§Œ ë³„ë„ ì¶”ì¶œ (ê²€ì¦ ì‹œ ë¶€ë¶„ ë§¤ì¹­ìš©)
        nameWithTitleMatches.forEach(match => {
          const nameOnly = match.match(/([ê°€-í£]{2,4})\s+/);
          if (nameOnly && nameOnly[1]) keywords.push(nameOnly[1]);
        });
      }

      // 3. ì¡°ì§ëª… íŒ¨í„´ (ì˜ˆ: ê²½ê¸°ë„ë‹¹, ì„œìš¸ì‹œë‹¹, êµìœ¡ìœ„ì›íšŒ)
      const orgMatches = text.match(/[ê°€-í£]{2,}(?:ë„ë‹¹|ì‹œë‹¹|êµ¬ë‹¹|ìœ„ì›íšŒ|ì¬ë‹¨|í˜‘íšŒ|ì—°í•©|ìœ„ì›íšŒ)/g);
      if (orgMatches) keywords.push(...orgMatches);

      // 4. ì´ë²¤íŠ¸ëª… íŒ¨í„´ (ì˜ˆ: ì²´ìœ¡ëŒ€íšŒ, í† ë¡ íšŒ, ê°„ë‹´íšŒ)
      const eventMatches = text.match(/[ê°€-í£]{2,}(?:ëŒ€íšŒ|í–‰ì‚¬|í† ë¡ íšŒ|ê°„ë‹´íšŒ|ì„¤ëª…íšŒ|ì„¸ë¯¸ë‚˜|ì›Œí¬ìˆ|íšŒì˜|ì§‘íšŒ|ì¶•ì œ)/g);
      if (eventMatches) keywords.push(...eventMatches);

      // 5. ì§€ëª… íŒ¨í„´ (ì˜ˆ: ì„œìš¸íŠ¹ë³„ì‹œ, ê²½ê¸°ë„, ìˆ˜ì›ì‹œ)
      const placeMatches = text.match(/[ê°€-í£]{2,}(?:íŠ¹ë³„ì‹œ|ê´‘ì—­ì‹œ|ë„|ì‹œ|êµ°|êµ¬|ì|ë©´|ë™)/g);
      if (placeMatches) keywords.push(...placeMatches);

      // 6. ì—°ë„/ë‚ ì§œ (ì˜ˆ: 2024ë…„, 2025ë…„)
      const yearMatches = text.match(/20[0-9]{2}ë…„/g);
      if (yearMatches) keywords.push(...yearMatches);

      // 7. ì •ì±…/ë²•ì•ˆëª… (ì˜ˆ: OOë²•, OOì •ì±…, OOì‚¬ì—…)
      const policyMatches = text.match(/[ê°€-í£]{2,}(?:ë²•|ì¡°ë¡€|ì •ì±…|ì‚¬ì—…|ê³„íš|ë°©ì•ˆ)/g);
      if (policyMatches) keywords.push(...policyMatches);

      // ì¤‘ë³µ ì œê±° ë° ë°˜í™˜
      return [...new Set(keywords)];
    }

    const backgroundKeywords = extractKeywordsFromInstructions(data.instructions);
    console.log('ğŸ” ë°°ê²½ì •ë³´ í•„ìˆ˜ í‚¤ì›Œë“œ:', backgroundKeywords);

    // ì¹´í…Œê³ ë¦¬ë¥¼ ì‘ë²•(writingMethod)ìœ¼ë¡œ ë§¤í•‘
    const categoryToWritingMethod = {
      'daily-communication': 'emotional_writing',
      'activity-report': 'direct_writing',
      'policy-proposal': 'logical_writing',
      'current-affairs': 'critical_writing',
      'local-issues': 'analytical_writing'
    };
    const writingMethod = categoryToWritingMethod[category] || 'emotional_writing';

    // buildSmartPrompt ì‚¬ìš© (ì¹´í…Œê³ ë¦¬ë³„ íŠ¹í™” í”„ë¡¬í”„íŠ¸)
    const prompt = await buildSmartPrompt({
      writingMethod,
      topic,
      authorBio: `${fullName} (${config.title || ''}, ${fullRegion || ''})`,
      targetWordCount,
      instructions: data.instructions,
      keywords: backgroundKeywords,
      newsContext,
      personalizedHints,
      applyEditorialRules: true
    });


    console.log(`ğŸ”¥ AI í˜¸ì¶œ ì‹œì‘ (1ê°œ ì›ê³  ìƒì„±) - ëª¨ë¸: ${modelName}...`);

    // ìµœëŒ€ 3ë²ˆ ì‹œë„ (ê²€ì¦ ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„)
    let apiResponse;
    let attempt = 0;
    const maxAttempts = 3;

    while (attempt < maxAttempts) {
      attempt++;
      console.log(`ğŸ”¥ AI í˜¸ì¶œ ì‹œë„ ${attempt}/${maxAttempts}...`);

      apiResponse = await callGenerativeModel(prompt, 1, modelName);

      // ê¸°ë³¸ ê²€ì¦
      if (apiResponse && apiResponse.length > 100) {
        // JSON íŒŒì‹±í•˜ì—¬ ì‹¤ì œ content ì¶”ì¶œ
        let contentToCheck = apiResponse;
        try {
          const jsonMatch = apiResponse.match(/```json\s*([\s\S]*?)\s*```/) ||
                           apiResponse.match(/\{[\s\S]*?\}/);
          if (jsonMatch) {
            const parsed = JSON.parse(jsonMatch[1] || jsonMatch[0]);
            contentToCheck = parsed.content || apiResponse;
          }
        } catch (e) {
          // JSON íŒŒì‹± ì‹¤íŒ¨ì‹œ ì›ë³¸ ì‚¬ìš©
        }

        // HTML íƒœê·¸ ì œê±°í•˜ê³  ìˆœìˆ˜ í…ìŠ¤íŠ¸ ê¸¸ì´ ê³„ì‚° (ê³µë°± ì œì™¸)
        const plainText = contentToCheck.replace(/<[^>]*>/g, '').replace(/\s/g, '');
        const actualWordCount = plainText.length;
        const minWordCount = Math.floor(targetWordCount * 0.9); // ëª©í‘œì˜ 90%

        console.log(`ğŸ“Š ë¶„ëŸ‰ ì²´í¬ - ì‹¤ì œ: ${actualWordCount}ì, ëª©í‘œ: ${targetWordCount}ì, ìµœì†Œ: ${minWordCount}ì`);

        // ì¤‘ìš”í•œ ë‚´ìš©ì´ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ ê²€ì¦
        const hasName = apiResponse.includes(fullName);
        const hasRegion = fullRegion ? apiResponse.includes(fullRegion) : true;
        const hasSufficientLength = actualWordCount >= minWordCount;

        console.log(`ğŸ” ê²€ì¦ ê²°ê³¼ - ì´ë¦„: ${hasName}, ì§€ì—­: ${hasRegion}, ë¶„ëŸ‰ì¶©ì¡±: ${hasSufficientLength}`);

        if (hasName && hasRegion && hasSufficientLength) {
          console.log(`âœ… ëª¨ë“  ê²€ì¦ í†µê³¼! (${attempt}ë²ˆì§¸ ì‹œë„)`);
          break;
        }

        if (attempt < maxAttempts) {
          if (!hasSufficientLength) {
            console.log(`âš ï¸ ë¶„ëŸ‰ ë¶€ì¡± (${actualWordCount}/${minWordCount}ì) - ì¬ìƒì„± í•„ìš”`);
            // ë¶„ëŸ‰ ë¶€ì¡±ì„ ëª…ì‹œì ìœ¼ë¡œ í”„ë¡¬í”„íŠ¸ì— ì¶”ê°€í•˜ì—¬ ì¬ì‹œë„
            prompt = prompt + `\n\n**ì¤‘ìš”: ë°˜ë“œì‹œ ${targetWordCount}ì ì´ìƒìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.**`;
          } else {
            console.log(`âŒ ê¸°íƒ€ ê²€ì¦ ì‹¤íŒ¨ - ì¬ì‹œë„ í•„ìš”`);
          }
          continue;
        }
      }

      if (attempt >= maxAttempts) {
        console.log(`âš ï¸ ìµœëŒ€ ì‹œë„ íšŸìˆ˜ ì´ˆê³¼ - í˜„ì¬ ì‘ë‹µ ì‚¬ìš©`);
      }
    }


    console.log(`âœ… AI ì‘ë‹µ ìµœì¢… ìˆ˜ì‹ , ê¸¸ì´: ${apiResponse.length} - ëª¨ë¸: ${modelName}`);

    // JSON íŒŒì‹±
    let parsedResponse;
    try {
      // JSON ë¸”ë¡ ì¶”ì¶œ
      const jsonMatch = apiResponse.match(/```json\s*([\s\S]*?)\s*```/) ||
                       apiResponse.match(/\{[\s\S]*?\}/);

      if (jsonMatch) {
        const jsonText = jsonMatch[1] || jsonMatch[0];
        console.log('ğŸ” ì¶”ì¶œëœ JSON ì¼ë¶€:', jsonText.substring(0, 200));
        parsedResponse = JSON.parse(jsonText);
        console.log('âœ… JSON íŒŒì‹± ì™„ë£Œ, ì œëª©:', parsedResponse.title);
      } else {
        throw new Error('JSON í˜•ì‹ ì°¾ê¸° ì‹¤íŒ¨');
      }
    } catch (parseError) {
      console.error('âŒ JSON íŒŒì‹± ì‹¤íŒ¨:', parseError.message);
      console.error('ì‘ë‹µ ë‚´ìš©:', apiResponse.substring(0, 500));

      // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ êµ¬ì¡° ìƒì„±
      parsedResponse = {
        title: `${topic} ê´€ë ¨ ì›ê³ `,
        content: `<p>${topic}ì— ëŒ€í•œ ì˜ê²¬ì„ ë‚˜ëˆ„ê³ ì í•©ë‹ˆë‹¤.</p><p>êµ¬ì²´ì ì¸ ë‚´ìš©ì€ AI ì‘ë‹µ íŒŒì‹±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>`,
        wordCount: 100
      };
    }

    // ğŸ”§ ê°•ì œ í›„ì²˜ë¦¬: AIê°€ ë¬´ì‹œí•œ í•„ìˆ˜ ì •ë³´ë“¤ì„ ì§ì ‘ ìˆ˜ì •
    console.log('ğŸ”© í›„ì²˜ë¦¬ ì‹œì‘ - í•„ìˆ˜ ì •ë³´ ê°•ì œ ì‚½ì…');

    if (parsedResponse && parsedResponse.content) {
      let fixedContent = parsedResponse.content;

      // 1. ê¸°ë³¸ì ì¸ í˜¸ì¹­ ìˆ˜ì •
      fixedContent = fixedContent.replace(/ì˜ì›ì…ë‹ˆë‹¤/g, `${fullName}ì…ë‹ˆë‹¤`);
      fixedContent = fixedContent.replace(/ì˜ì›ìœ¼ë¡œì„œ/g, `${config.title}ìœ¼ë¡œì„œ`);
      fixedContent = fixedContent.replace(/êµ­íšŒ ì˜ì›/g, config.title);
      fixedContent = fixedContent.replace(/\sì˜ì›\s/g, ` ${config.title} `);

      // ì€í‡´ ìƒíƒœ íŠ¹ë³„ ìˆ˜ì • - ëª¨ë“  í˜¸ì¹­ê³¼ ê³µì•½ í™œë™ í‘œí˜„ ì œê±°
      if (currentStatus === 'ì€í‡´') {
        // ëª¨ë“  í˜¸ì¹­ ì œê±° (ì²« ì¸ì‚¬ ì´í›„)
        fixedContent = fixedContent.replace(/ì€í‡´ì˜ˆë¹„í›„ë³´/g, 'ì €');
        fixedContent = fixedContent.replace(/ì˜ˆë¹„í›„ë³´/g, 'ì €');
        fixedContent = fixedContent.replace(/ì˜ì›ìœ¼ë¡œì„œ/g, 'ì €ë¡œì„œ');
        fixedContent = fixedContent.replace(/ì€í‡´.*ì˜ˆë¹„í›„ë³´.*ë¡œì„œ/g, 'ì €ë¡œì„œ');

        // ê³µì•½/ì •ì¹˜ í™œë™ í‘œí˜„ ì œê±°
        fixedContent = fixedContent.replace(/ì˜ì •í™œë™ì„ í†µí•´/g, 'ì œ ê²½í—˜ê³¼ì˜ ì†Œí†µì„ í†µí•´');
        fixedContent = fixedContent.replace(/í˜„ì—­ ì˜ì›ìœ¼ë¡œì„œ/g, 'ì €ë¡œì„œ');
        fixedContent = fixedContent.replace(/ì„±ê³¼ë¥¼/g, 'ê²½í—˜ì„');
        fixedContent = fixedContent.replace(/ì‹¤ì ì„/g, 'í™œë™ì„');
        fixedContent = fixedContent.replace(/ì¶”ì§„í•˜ê² ìŠµë‹ˆë‹¤/g, 'ìƒê°í•©ë‹ˆë‹¤');
        fixedContent = fixedContent.replace(/ê¸°ì—¬í•˜ê² ìŠµë‹ˆë‹¤/g, 'ê´€ì‹¬ì„ ê°–ê³  ìˆìŠµë‹ˆë‹¤');

        // 3ì¸ì¹­ì„ 1ì¸ì¹­ ë³€ê²½ (ì²« ì¸ì‚¬ ì´í›„)
        // "ê°•ì •êµ¬ëŠ”" -> "ì €ëŠ”" (ë‹¨ ì²« ì¸ì‚¬ ë¬¸ì¥ì€ ì œì™¸)
        const sentences = fixedContent.split('</p>');
        for (let i = 1; i < sentences.length; i++) { // ì²«ë²ˆì§¸ ë¬¸ë‹¨(ì¸ì‚¬) ì´í›„ë¶€í„° ì ìš©
          sentences[i] = sentences[i].replace(new RegExp(`${fullName}ëŠ”`, 'g'), 'ì €ëŠ”');
          sentences[i] = sentences[i].replace(new RegExp(`${fullName}ê°€`, 'g'), 'ì œê°€');
          sentences[i] = sentences[i].replace(new RegExp(`${fullName}ë¥¼`, 'g'), 'ì €ë¥¼');
          sentences[i] = sentences[i].replace(new RegExp(`${fullName}ì˜`, 'g'), 'ì €ì˜');
        }
        fixedContent = sentences.join('</p>');

        // ë§ˆì§€ë§‰ í˜•ì‹ ë§ˆë¬´ë¦¬/ì¸ì‚¬ ì™„ì „ ì œê±°
        fixedContent = fixedContent.replace(new RegExp(`${fullName} ë“œë¦¼`, 'g'), '');
        fixedContent = fixedContent.replace(/ë“œë¦¼<\/p>/g, '</p>');
        fixedContent = fixedContent.replace(/<p>ë“œë¦¼<\/p>/g, '');
        fixedContent = fixedContent.replace(/\n\në“œë¦¼$/g, '');
        fixedContent = fixedContent.replace(/ë“œë¦¼$/g, '');
        fixedContent = fixedContent.replace(/ì˜¬ë¦¼<\/p>/g, '</p>');
        fixedContent = fixedContent.replace(/<p>ì˜¬ë¦¼<\/p>/g, '');

        // ì´ìƒí•œ ì§€ì—­ í‘œí˜„ ìˆ˜ì •
        const regionName = userProfile.regionLocal || userProfile.regionMetro || 'ì–‘ì–‘êµ°ì‹œ';
        const baseRegion = regionName.replace('ë„ë¯¼', '').replace('ë¯¼', '');
        fixedContent = fixedContent.replace(new RegExp(`${baseRegion}ë„ë¯¼ ê²½ì œ`, 'g'), `${baseRegion} ê²½ì œ`);
        fixedContent = fixedContent.replace(new RegExp(`${baseRegion}ë„ë¯¼ ê´€ê´‘`, 'g'), `${baseRegion} ê´€ê´‘`);
        fixedContent = fixedContent.replace(new RegExp(`${baseRegion}ë„ë¯¼ ë°œì „`, 'g'), `${baseRegion} ë°œì „`);

        // ì¤‘ë³µ/ì´ìƒí•œ í‘œí˜„ ì •ë¦¬
        fixedContent = fixedContent.replace(/ì–‘ì–‘êµ°ì‹œë¯¼ì„ í¬í•¨í•œ ë§ì€ êµ°ë¯¼ë“¤/g, 'ë§ì€ ì£¼ë¯¼ë“¤');
        fixedContent = fixedContent.replace(/ì–‘ì–‘êµ°ì‹œë¯¼ ì—¬ëŸ¬ë¶„ì„ í¬í•¨í•œ/g, 'ì œ ì—¬ëŸ¬ë¶„ì„ í¬í•¨í•œ');

        // ë¶ˆì™„ì „í•œ ë¬¸ì¥ ê°ì§€ ë° ì œê±° (ì¡°ì‚¬ê°€ ëë‚˜ëŠ” ë¬¸ì¥)
        fixedContent = fixedContent.replace(/([ê°€-í£]+)\s*<\/p>/g, (match, word) => {
          if (!word.match(/[ë‹¤ìš”ê¹Œë‹ˆë‹¤ìš”ë©´ë„¤ìš”ìŠµê²ƒìŒì„ìŒ]$/)) {
            // ë¶ˆì™„ì „í•œ ë¬¸ì¥ìœ¼ë¡œ ë³´ì´ë©´ ì´ì „ ì™„ì „í•œ ë¬¸ì¥ì—ì„œ ì¢…ë£Œ
            return '</p>';
          }
          return match;
        });

        // ë¹ˆ ë¬¸ë‹¨ ì œê±°
        fixedContent = fixedContent.replace(/<p><\/p>/g, '');
        fixedContent = fixedContent.replace(/<p>\s*<\/p>/g, '');

        // ì´ìƒí•œ ì¡°ì‚¬ ìˆ˜ì •
        fixedContent = fixedContent.replace(/ì–‘ì–‘êµ°ì„ í†µí•´/g, 'ì–‘ì–‘êµ°ë‚´ë¥¼ í†µí•´');
        fixedContent = fixedContent.replace(/ì–‘ì–‘êµ°ì„/g, 'ì–‘ì–‘êµ°ë‚´ë¥¼');
      }

      // 2. ì¸ì‚¬ë§ì— ì´ë¦„ ì‚½ì… (ì¤‘ë³µë˜ì§€ ì•Šë„ë¡ ì¡°ì‹¬ìŠ¤ëŸ½ê²Œ)
      // "ì•ˆë…•í•˜ì„¸ìš”?"ë¥¼ "ì•ˆë…•í•˜ì„¸ìš”, {ì´ë¦„}ì…ë‹ˆë‹¤"ë¡œ ë³€ê²½ (ì´ë¯¸ ì´ë¦„ì´ ì—†ëŠ” ê²½ìš°ë§Œ)
      if (!fixedContent.includes(`ì € ${fullName}`)) {
        fixedContent = fixedContent.replace(/(<p>)ì•ˆë…•í•˜ì„¸ìš”/g, `$1ì•ˆë…•í•˜ì„¸ìš” ${fullName}ì…ë‹ˆë‹¤`);
      }
      // "ì•ˆë…• "ë‹¤ìŒì— ì´ë¦„ì´ ì—†ëŠ” ê²½ìš°ë§Œ ì´ë¦„ ì‚½ì…
      fixedContent = fixedContent.replace(/(<p>)ì•ˆë…• ([^ê°€-í£])/g, `$1ì•ˆë…• ${fullName} $2`);

      // 3. ì¸ì‚¬ë§ ì§€ì—­ì •ë³´ ìˆ˜ì •
      if (fullRegion) {
        // êµ¬ì²´ì ì¸ íŒ¨í„´ë§Œ êµì²´
        fixedContent = fixedContent.replace(/ìš°ë¦¬ ì§€ì—­ì˜/g, `${fullRegion}ì˜`);
        fixedContent = fixedContent.replace(/ìš°ë¦¬ ì§€ì—­ì—/g, `${fullRegion}ì—`);
        fixedContent = fixedContent.replace(/ì§€ì—­ì˜/g, `${fullRegion} `);
        fixedContent = fixedContent.replace(/\së¥¼\s/g, ` ${fullRegion}ë¥¼`);
        fixedContent = fixedContent.replace(/\sì˜ ë°œì „ì„/g, ` ${fullRegion}ì˜ ë°œì „ì„`);
        fixedContent = fixedContent.replace(/ì—ì„œì˜/g, `${fullRegion}ì—ì„œì˜`);

        // ë¹ˆ ì§€ì—­ ì°¸ì¡° íŒ¨í„´ ì°¾ì•„ì„œ ìˆ˜ì •
        fixedContent = fixedContent.replace(/,\s*ì˜\s/g, `, ${fullRegion}ì˜`);
        fixedContent = fixedContent.replace(/\s*ì—ì„œ\s*ì¸/g, ` ${fullRegion}ì—ì„œ ì¸êµ¬`);
      }

      // 4. ì‹œì‘ ë¬¸ì¥ì— í˜¸ì¹­ë¥¼ í¬í•¨í•˜ì§€ ì•Šìœ¼ë©´ ê°•ì œ ìˆ˜ì •
      if (!fixedContent.includes(`${fullName}ì…ë‹ˆë‹¤`)) {
        // ì²«ë²ˆì§¸ p íƒœê·¸ ì°¾ì•„ì„œ êµì²´
        fixedContent = fixedContent.replace(/^<p>[^<]*?<\/p>/,
          `<p>ì¡´ê²½í•˜ëŠ” ${fullRegion} ë„ë¯¼ ì—¬ëŸ¬ë¶„ ${fullName}ì…ë‹ˆë‹¤.</p>`);
      }

      // 5. ë§ˆì§€ë§‰ì— ì„œëª… ìˆ˜ì • (ì€í‡´ ìƒíƒœê°€ ì•„ë‹ ë•Œë§Œ)
      if (currentStatus !== 'ì€í‡´') {
        fixedContent = fixedContent.replace(/ì˜ì› ì˜¬ë¦¼/g, `${fullName} ë“œë¦¼`);
        fixedContent = fixedContent.replace(/ì˜ì› ë“œë¦¼/g, `${fullName} ë“œë¦¼`);

        // ì„œëª…ì´ ì—†ìœ¼ë©´ ì¶”ê°€
        if (!fixedContent.includes(`${fullName} ë“œë¦¼`) && !fixedContent.includes(`${fullName} ì˜¬ë¦¼`)) {
          fixedContent = fixedContent.replace(/<\/p>$/, `</p><p>${fullName} ë“œë¦¼</p>`);
        }
      }

      // 6. ê¸°íƒ€ íŒ¨í„´ ìˆ˜ì •
      fixedContent = fixedContent.replace(/ë„ë¯¼ ì—¬ëŸ¬ë¶„ ì˜ì›ì…ë‹ˆë‹¤/g, `ë„ë¯¼ ì—¬ëŸ¬ë¶„ ${fullName}ì…ë‹ˆë‹¤`);
      fixedContent = fixedContent.replace(/ì—¬ëŸ¬ë¶„ê»˜, ì˜ì›ì…ë‹ˆë‹¤/g, `ì—¬ëŸ¬ë¶„ê»˜, ${fullName}ì…ë‹ˆë‹¤`);

      // ë¶ˆì™„ì „í•œ ë¬¸ì¥ ìˆ˜ì •
      fixedContent = fixedContent.replace(/í–‰ë³µí•˜ê² ìŠµë‹ˆë‹¤/g, 'í–‰ë³µì„ ë†’ì´ê² ìŠµë‹ˆë‹¤');
      fixedContent = fixedContent.replace(/ë„ë¯¼ë“¤ì˜ ëª©ì†Œë¦¬ì¬í˜„/g, 'ë„ë¯¼ë“¤ì˜ ëª©ì†Œë¦¬ë¥¼ ë“£ê³  ìˆì¬í˜„');
      fixedContent = fixedContent.replace(/ëª¨ë‘ì˜ ì†Œí†µ ë¯¸ë˜ë¥¼/g, 'ëª¨ë‘ì˜ ì†Œí†µì„ ì±„ì›Œê°€ë©° ë¯¸ë˜ë¥¼');

      // ì´ìƒí•œ í…ìŠ¤íŠ¸ ì¡°ê° ìˆ˜ì •
      fixedContent = fixedContent.replace(/ì–‘ì–‘êµ°ì‹œë¯¼ë“¤ì´ í–‰ë³µì´/g, 'ì–‘ì–‘êµ°ì‹œë¯¼ ì—¬ëŸ¬ë¶„ì„ ìœ„í•´ í–‰ë³µì´');
      fixedContent = fixedContent.replace(/ë¶ˆì—¬í•´ì„œ/g, 'ì œ ì—¬ëŸ¬ë¶„ê»˜');
      fixedContent = fixedContent.replace(/([ê°€-í£]+) ([ê°€-í£]+)ë¥¼ í†µí•´/g, (match, word1, word2) => {
        if (word2.includes('êµ°ì„') || word2.includes('ì‹œë¥¼')) {
          return `${word1} ${word2.replace('ì„', 'ë¥¼')} í†µí•´`;
        }
        return match;
      });

      // ğŸ”© ìµœì¢… ì¤‘ë³µ ì´ë¦„ íŒ¨í„´ ì œê±° (ëª¨ë“  ì²˜ë¦¬ ì™„ë£Œ í›„)
      console.log('ğŸ”© ìµœì¢… ì¤‘ë³µ ì´ë¦„ ì œê±° ì‹œì‘');
      fixedContent = fixedContent.replace(new RegExp(`ì•ˆë…• ${fullName} ${fullName}ì…`, 'g'), `ì•ˆë…• ${fullName}ì…`);
      fixedContent = fixedContent.replace(new RegExp(`ì•ˆë…• ${fullName} ${fullName}ê°€`, 'g'), `ì•ˆë…• ${fullName}ê°€`);
      fixedContent = fixedContent.replace(new RegExp(`ì•ˆë…• ${fullName} ${fullName}ë¥¼`, 'g'), `ì•ˆë…• ${fullName}ë¥¼`);
      fixedContent = fixedContent.replace(new RegExp(`ì•ˆë…• ${fullName} ${fullName}`, 'g'), `ì•ˆë…• ${fullName}`);
      fixedContent = fixedContent.replace(new RegExp(`${fullName} ${fullName}ì…`, 'g'), `${fullName}ì…`);
      fixedContent = fixedContent.replace(new RegExp(`${fullName} ${fullName}ê°€`, 'g'), `${fullName}ê°€`);
      fixedContent = fixedContent.replace(new RegExp(`${fullName} ${fullName}ë¥¼`, 'g'), `${fullName}ë¥¼`);
      fixedContent = fixedContent.replace(new RegExp(`${fullName} ${fullName}`, 'g'), fullName);

      // 3ì—°ì† ì´ìƒ ì¤‘ë³µë„ ì²˜ë¦¬
      fixedContent = fixedContent.replace(new RegExp(`${fullName} ${fullName} ${fullName}`, 'g'), fullName);
      fixedContent = fixedContent.replace(new RegExp(`ì•ˆë…• ${fullName} ${fullName} ${fullName}`, 'g'), `ì•ˆë…• ${fullName}`);

      parsedResponse.content = fixedContent;
      console.log('âœ… í›„ì²˜ë¦¬ ì™„ë£Œ - í•„ìˆ˜ ì •ë³´ ì‚½ì…ë¨');
    }

    // 2ë‹¨ê³„: ë³¸ë¬¸ ê¸°ë°˜ ì œëª© ìƒì„±
    const generatedTitle = await generateTitleFromContent({
      content: parsedResponse.content || '',
      backgroundInfo: data.instructions,
      keywords: backgroundKeywords,
      topic,
      fullName,
      modelName
    });

    // drafts í˜•ì‹ìœ¼ë¡œ ë°˜í™˜ (í”„ë¡ íŠ¸ì—”ë“œ í˜¸í™˜ì„±)
    const draftData = {
      id: `draft_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      title: generatedTitle,
      content: parsedResponse.content || `<p>${topic}ì— ëŒ€í•œ ë‚´ìš©ì…ë‹ˆë‹¤.</p>`,
      wordCount: parsedResponse.wordCount || parsedResponse.content?.replace(/<[^>]*>/g, '').length || 0,
      category,
      subCategory: data.subCategory || '',
      keywords: data.keywords || '',
      generatedAt: new Date().toISOString()
    };

    // ì‚¬ìš©ëŸ‰ ì—…ë°ì´íŠ¸ (ê´€ë¦¬ìëŠ” ì¹´ìš´íŠ¸í•˜ì§€ ì•ŠìŒ)
    if (userProfile && Object.keys(userProfile).length > 0) {
      const isAdmin = userProfile.isAdmin === true;

      try {
        if (useBonus) {
          // ë³´ë„ˆìŠ¤ ì‚¬ìš©ëŸ‰ ì¦ê°€ (í•˜ë£¨ ì‚¬ìš©ëŸ‰ë„ í•¨ê»˜ ì¦ê°€)
          const today = new Date();
          const todayKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

          await db.collection('users').doc(uid).update({
            'usage.bonusUsed': admin.firestore.FieldValue.increment(1),
            [`dailyUsage.${todayKey}`]: isAdmin ? 0 : admin.firestore.FieldValue.increment(1), // ê´€ë¦¬ìëŠ” í•˜ë£¨ ì¹´ìš´íŠ¸ ì œì™¸
            lastBonusUsed: admin.firestore.FieldValue.serverTimestamp()
          });
          console.log('âœ… ë³´ë„ˆìŠ¤ ì›ê³  ì‚¬ìš©ëŸ‰ ì—…ë°ì´íŠ¸', isAdmin ? '(ê´€ë¦¬ì - í•˜ë£¨ ì¹´ìš´íŠ¸ ì œì™¸)' : '');
        } else {
          // ì¼ë°˜ ì‚¬ìš©ëŸ‰ ì¦ê°€ (ê´€ë¦¬ìëŠ” ì¹´ìš´íŠ¸í•˜ì§€ ì•ŠìŒ)
          if (!isAdmin) {
            const today = new Date();
            const todayKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

            await db.collection('users').doc(uid).update({
              'usage.postsGenerated': admin.firestore.FieldValue.increment(1),
              [`dailyUsage.${todayKey}`]: admin.firestore.FieldValue.increment(1),
              lastGenerated: admin.firestore.FieldValue.serverTimestamp()
            });
            console.log('âœ… ì¼ë°˜ ì›ê³  ì‚¬ìš©ëŸ‰ ë° í•˜ë£¨ ì‚¬ìš©ëŸ‰ ì—…ë°ì´íŠ¸');
          } else {
            // ê´€ë¦¬ìëŠ” ì‚¬ìš©ëŸ‰ ì¹´ìš´íŠ¸í•˜ì§€ ì•ŠìŒ (ìƒì„± ê¸°ë¡ë§Œ ì €ì¥)
            await db.collection('users').doc(uid).update({
              lastGenerated: admin.firestore.FieldValue.serverTimestamp()
            });
            console.log('âœ… ê´€ë¦¬ì ê³„ì • - ì‚¬ìš©ëŸ‰ ì¹´ìš´íŠ¸ ì—†ì´ ê¸°ë¡ë§Œ ì—…ë°ì´íŠ¸');
          }
        }
      } catch (updateError) {
        console.warn('âš ï¸ ì‚¬ìš©ëŸ‰ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', updateError.message);
      }
    }

    console.log('âœ… generatePosts ì™„ë£Œ:', {
      title: draftData.title,
      wordCount: draftData.wordCount,
      useBonus
    });

    // ê²½ê³  ë©”ì‹œì§€ ìƒì„±
    let message = useBonus ? 'ë³´ë„ˆìŠ¤ ì›ê³ ê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤' : 'ì›ê³ ê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤';
    if (dailyLimitWarning) {
      message += '\n\nâš ï¸ í•˜ë£¨ 3íšŒ ì´ìƒ ì›ê³ ë¥¼ ìƒì„±í•˜ì…¨ìŠµë‹ˆë‹¤. ë„¤ì´ë²„ ë¸”ë¡œê·¸ ì •ì±…ìƒ ê³¼ë„í•œ ë°œí–‰ì€ ìŠ¤íŒ¸ìœ¼ë¡œ ë¶„ë¥˜ë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ë°˜ë“œì‹œ ë§ˆì§€ë§‰ í¬ìŠ¤íŒ…ìœ¼ë¡œë¶€í„° 3ì‹œê°„ ê²½ê³¼ í›„ ë°œí–‰í•´ ì£¼ì„¸ìš”';
    }

    return ok({
      success: true,
      message: message,
      dailyLimitWarning: dailyLimitWarning,
      drafts: draftData,
      metadata: {
        generatedAt: new Date().toISOString(),
        userId: uid,
        processingTime: Date.now(),
        usedBonus: useBonus
      }
    });

  } catch (error) {
    console.error('âŒ generatePosts ì˜¤ë¥˜:', error.message);
    throw new HttpsError('internal', 'ì›ê³  ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
  }
});


// saveSelectedPost - ì„ íƒëœ ì›ê³  ì €ì¥
exports.saveSelectedPost = httpWrap(async (req) => {
  let uid;

  // ë°ì´í„° ì¶”ì¶œ - Firebase SDKì™€ HTTP ìš”ì²­ ëª¨ë‘ ì²˜ë¦¬
  let requestData = req.data || req.rawRequest?.body || {};

  // ì¤‘ì²©ëœ data êµ¬ì¡° ì²˜ë¦¬
  if (requestData.data && typeof requestData.data === 'object') {
    requestData = requestData.data;
  }

  // ì‚¬ìš©ì ì¸ì¦ ë°ì´í„° í™•ì¸ (ëª¨ë“  ì‚¬ìš©ìëŠ” ë„¤ì´ë²„ ë¡œê·¸ì¸)
  if (requestData.__naverAuth && requestData.__naverAuth.uid && requestData.__naverAuth.provider === 'naver') {
    console.log('ğŸ“± ì‚¬ìš©ì ì¸ì¦ ì²˜ë¦¬:', requestData.__naverAuth.uid);
    uid = requestData.__naverAuth.uid;
    // ì¸ì¦ ì •ë³´ ì œê±° (ì²˜ë¦¬ ì™„ë£Œ)
    delete requestData.__naverAuth;
  } else {
    const authHeader = (req.rawRequest && (req.rawRequest.headers.authorization || req.rawRequest.headers.Authorization)) || '';
    if (authHeader && authHeader.startsWith('Bearer ')) {
      const idToken = authHeader.split('Bearer ')[1];
      try {
        const verified = await admin.auth().verifyIdToken(idToken);
        uid = verified.uid;
      } catch (authError) {
        console.error('ID token verify failed:', authError);
        throw new HttpsError('unauthenticated', 'ìœ íš¨í•˜ì§€ ì•Šì€ ì¸ì¦ í† í°ì…ë‹ˆë‹¤.');
      }
    } else {
      console.error('ì¸ì¦ ì •ë³´ ëˆ„ë½:', requestData);
      throw new HttpsError('unauthenticated', 'ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.');
    }
  }

  const data = requestData;

  console.log('POST saveSelectedPost ì‹œì‘:', { userId: uid, data });

  if (!data.title || !data.content) {
    throw new HttpsError('invalid-argument', 'ì œëª©ê³¼ ë‚´ìš©ì´ í•„ìš”í•©ë‹ˆë‹¤');
  }

  try {
    const wordCount = data.content.replace(/<[^>]*>/g, '').length;

    const postData = {
      userId: uid,
      title: data.title,
      content: data.content,
      category: data.category || 'ì¼ë°˜',
      subCategory: data.subCategory || '',
      keywords: data.keywords || '',
      wordCount,
      status: 'published',
      createdAt: admin.firestore.FieldValue.serverTimestamp(),
      updatedAt: admin.firestore.FieldValue.serverTimestamp()
    };

    const docRef = await db.collection('posts').add(postData);

    console.log('POST saveSelectedPost ì™„ë£Œ:', { postId: docRef.id, wordCount });

    return ok({
      success: true,
      message: 'ì›ê³ ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.',
      postId: docRef.id
    });

  } catch (error) {
    console.error('POST saveSelectedPost ì˜¤ë¥˜:', error.message);
    throw new HttpsError('internal', 'ì›ê³  ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
});
