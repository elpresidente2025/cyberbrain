/**
 * functions/services/guidelines/reminder.js
 * ë¦¬ë§ˆì¸ë” ìƒì„±ê¸° - "ê°€ì¥ ì£¼ì˜í•´ì•¼ í•  3ê°€ì§€" ì²´í¬ë¦¬ìŠ¤íŠ¸
 *
 * í”„ë¡¬í”„íŠ¸ ë§¨ ëì— ë°°ì¹˜í•˜ì—¬ Recency Effect ê·¹ëŒ€í™”
 */

'use strict';

/**
 * CRITICAL ì²­í¬ë“¤ë¡œë¶€í„° ë¦¬ë§ˆì¸ë” ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒì„±
 *
 * @param {Array} criticalChunks - CRITICAL ìš°ì„ ìˆœìœ„ ì²­í¬ ë°°ì—´
 * @param {Object} context - ì»¨í…ìŠ¤íŠ¸ { status, topic }
 * @returns {string} ë¦¬ë§ˆì¸ë” í…ìŠ¤íŠ¸
 */
function generateReminder(criticalChunks, context = {}) {
  if (!criticalChunks || criticalChunks.length === 0) {
    return generateDefaultReminder();
  }

  // ìƒìœ„ 3ê°œ ì„ íƒ (ì¤‘ë³µ íƒ€ì… ì œê±°í•˜ì—¬ ë‹¤ì–‘ì„± í™•ë³´)
  const selectedTypes = new Set();
  const top3 = [];

  for (const chunk of criticalChunks) {
    if (top3.length >= 3) break;

    // ê°™ì€ íƒ€ì…ì€ í•˜ë‚˜ë§Œ
    if (!selectedTypes.has(chunk.type)) {
      top3.push(chunk);
      selectedTypes.add(chunk.type);
    }
  }

  // 3ê°œ ë¯¸ë§Œì´ë©´ ë‚˜ë¨¸ì§€ ì±„ìš°ê¸°
  if (top3.length < 3) {
    for (const chunk of criticalChunks) {
      if (top3.length >= 3) break;
      if (!top3.includes(chunk)) {
        top3.push(chunk);
      }
    }
  }

  // ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒì„±
  const checklistItems = top3.map((chunk, index) => {
    const example = chunk.examples?.[0];
    let item = `â–¡ ${index + 1}. ${chunk.instruction}`;

    if (example) {
      item += `\n   âŒ "${truncate(example.bad, 40)}"`;
      item += `\n   âœ… "${truncate(example.good, 40)}"`;
    }

    return item;
  }).join('\n\n');

  // ìƒíƒœë³„ ê°•ì¡° ë©”ì‹œì§€
  const statusWarning = getStatusWarning(context.status);

  return `
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âš ï¸ [ì¶œë ¥ ì „ ìµœì¢… ì ê²€] ì•„ë˜ ${top3.length}ê°€ì§€ë¥¼ ìœ„ë°˜í•˜ë©´ ì›ê³ ê°€ íê¸°ë©ë‹ˆë‹¤
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
${statusWarning}
${checklistItems}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ ìœ„ ${top3.length}ê°€ì§€ë¥¼ ìµœì¢… í™•ì¸ í›„ JSONì„ ì¶œë ¥í•˜ì„¸ìš”.
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
`;
}

/**
 * ìƒíƒœë³„ ê²½ê³  ë©”ì‹œì§€
 */
function getStatusWarning(status) {
  if (status === 'ì¤€ë¹„' || status === 'í˜„ì—­') {
    return `
ğŸš¨ í˜„ì¬ ìƒíƒœ: ${status} (ì˜ˆë¹„í›„ë³´ ë“±ë¡ ì´ì „)
   "~í•˜ê² ìŠµë‹ˆë‹¤" í˜•íƒœ ê³µì•½ í‘œí˜„ ì‚¬ìš© ì‹œ ì›ê³  ì¦‰ì‹œ íê¸°!
`;
  }

  if (status === 'ì˜ˆë¹„') {
    return `
ğŸ“Œ í˜„ì¬ ìƒíƒœ: ì˜ˆë¹„í›„ë³´
   "íˆ¬í‘œí•´ ì£¼ì‹­ì‹œì˜¤"ëŠ” ì•„ì§ ì‚¬ìš© ë¶ˆê°€
`;
  }

  return '';
}

/**
 * ê¸°ë³¸ ë¦¬ë§ˆì¸ë” (ì²­í¬ ì—†ì„ ë•Œ)
 */
function generateDefaultReminder() {
  return `
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âš ï¸ [ì¶œë ¥ ì „ ìµœì¢… ì ê²€] í•„ìˆ˜ í™•ì¸ì‚¬í•­
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â–¡ 1. ê°™ì€ ë¬¸ì¥ì´ 2íšŒ ì´ìƒ ë°˜ë³µë˜ì§€ ì•Šì•˜ëŠ”ê°€?
   âŒ ë™ì¼ ë¬¸ì¥ ë°˜ë³µ
   âœ… ê° ë¬¸ì¥ì€ ìƒˆë¡œìš´ ì •ë³´ í¬í•¨

â–¡ 2. ë§ˆë¬´ë¦¬ ì¸ì‚¬ ì´í›„ ë³¸ë¬¸ì´ ë‹¤ì‹œ ì‹œì‘ë˜ì§€ ì•Šì•˜ëŠ”ê°€?
   âŒ "ê°ì‚¬í•©ë‹ˆë‹¤" ì´í›„ ìƒˆ ë‚´ìš©
   âœ… ë§ˆë¬´ë¦¬ í›„ ì¦‰ì‹œ ì¢…ë£Œ

â–¡ 3. ëª¨ë“  ë¬¸ì¥ì´ ì™„ì „í•œ í˜•íƒœë¡œ ëë‚˜ëŠ”ê°€?
   âŒ "ì£¼ë¯¼ ì—¬ëŸ¬ë¶„ê³¼ í•¨ê»˜" (ë¯¸ì™„ê²°)
   âœ… "ì£¼ë¯¼ ì—¬ëŸ¬ë¶„ê³¼ í•¨ê»˜ ë§Œë“¤ì–´ê°€ê² ìŠµë‹ˆë‹¤."

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ ìœ„ 3ê°€ì§€ë¥¼ ìµœì¢… í™•ì¸ í›„ JSONì„ ì¶œë ¥í•˜ì„¸ìš”.
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
`;
}

/**
 * ì„ ê±°ë²• íŠ¹í™” ë¦¬ë§ˆì¸ë” (ì¤€ë¹„/í˜„ì—­ ìƒíƒœ)
 */
function generateElectionLawReminder(status) {
  if (status !== 'ì¤€ë¹„' && status !== 'í˜„ì—­') {
    return '';
  }

  return `
ğŸš¨ğŸš¨ğŸš¨ [ì„ ê±°ë²• ìµœì¢… í™•ì¸] ğŸš¨ğŸš¨ğŸš¨

ë‹¤ìŒ í‘œí˜„ì´ ì›ê³ ì— í¬í•¨ë˜ì–´ ìˆë‹¤ë©´ ì¦‰ì‹œ ìˆ˜ì •í•˜ì„¸ìš”:

âŒ ê¸ˆì§€ í‘œí˜„:
â€¢ "~í•˜ê² ìŠµë‹ˆë‹¤" (ì¶”ì§„í•˜ê² ìŠµë‹ˆë‹¤, ì‹¤í˜„í•˜ê² ìŠµë‹ˆë‹¤, ë§Œë“¤ê² ìŠµë‹ˆë‹¤...)
â€¢ "ê³µì•½" (ê³µì•½ ë°œí‘œ, ê³µì•½ ì‚¬í•­, ì²« ë²ˆì§¸ ê³µì•½...)
â€¢ "ì•½ì†ë“œë¦½ë‹ˆë‹¤", "ë‹¹ì„ ë˜ë©´", "ì§€ì§€í•´ ì£¼ì‹­ì‹œì˜¤"

âœ… ëŒ€ì²´ í‘œí˜„:
â€¢ "~ì´ í•„ìš”í•©ë‹ˆë‹¤", "~ì„ ì œì•ˆí•©ë‹ˆë‹¤", "~ì„ ì—°êµ¬í•˜ê³  ìˆìŠµë‹ˆë‹¤"
â€¢ "ì •ì±… ë°©í–¥", "ë¹„ì „", "ì •ì±… ì œì•ˆ"
â€¢ "ì´ ë°©í–¥ìœ¼ë¡œ ë…¸ë ¥í•˜ê² ìŠµë‹ˆë‹¤", "ê´€ì‹¬ ê°€ì ¸ ì£¼ì‹­ì‹œì˜¤"

ìœ„ í‘œí˜„ì´ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ì›ê³ ê°€ íê¸°ë©ë‹ˆë‹¤!
`;
}

/**
 * ê°„ë‹¨í•œ í•œ ì¤„ ë¦¬ë§ˆì¸ë” (í”„ë¡¬í”„íŠ¸ ìš©ëŸ‰ ì ˆì•½ìš©)
 */
function generateCompactReminder(criticalChunks, status) {
  const items = [];

  // ì„ ê±°ë²• ê´€ë ¨
  if (status === 'ì¤€ë¹„' || status === 'í˜„ì—­') {
    items.push('~í•˜ê² ìŠµë‹ˆë‹¤ ê¸ˆì§€');
  }

  // ë°˜ë³µ ê´€ë ¨
  items.push('ë¬¸ì¥ ë°˜ë³µ ê¸ˆì§€');

  // êµ¬ì¡° ê´€ë ¨
  items.push('ë§ˆë¬´ë¦¬ í›„ ì¢…ë£Œ');

  return `âš ï¸ ìµœì¢… í™•ì¸: ${items.join(' | ')}`;
}

/**
 * ë¬¸ìì—´ truncate
 */
function truncate(str, maxLength) {
  if (!str) return '';
  if (str.length <= maxLength) return str;
  return str.substring(0, maxLength - 3) + '...';
}

module.exports = {
  generateReminder,
  generateDefaultReminder,
  generateElectionLawReminder,
  generateCompactReminder
};
