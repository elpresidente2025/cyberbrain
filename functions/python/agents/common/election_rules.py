# functions/python/agents/common/election_rules.py
# ì„ ê±°ë²• ì¤€ìˆ˜ í‘œí˜„ ê·œì¹™ ë° ìœ í‹¸ë¦¬í‹° (Node.js election-rules.js ì™„ì „ ì´ì‹)

import re
from typing import List, Dict, Any, Optional, Tuple

# ============================================================================
# ì„ ê±°ë²• ì¤€ìˆ˜ í‘œí˜„ ê·œì¹™ (3ë‹¨ê³„)
# 1ë‹¨ê³„: ì˜ˆë¹„í›„ë³´ ë“±ë¡ ì´ì „ (ì¤€ë¹„, í˜„ì—­)
# 2ë‹¨ê³„: ì˜ˆë¹„í›„ë³´ ë“±ë¡ ì´í›„ (ì˜ˆë¹„)
# 3ë‹¨ê³„: ë³¸ í›„ë³´ ë“±ë¡ ì´í›„ (í›„ë³´)
# ============================================================================

ELECTION_EXPRESSION_RULES = {
    # 1ë‹¨ê³„: ì˜ˆë¹„í›„ë³´ ë“±ë¡ ì´ì „
    "STAGE_1": {
        "applies_to": ['ì¤€ë¹„', 'í˜„ì—­', 'active'],
        "description": 'ì˜ˆë¹„í›„ë³´ ë“±ë¡ ì´ì „ - ì¼ë°˜ ì •ì¹˜ì¸, ë‹¹ì§ì, í˜„ì—­ ì˜ì›/ë‹¨ì²´ì¥',
        "forbidden": {
            # ì‹ ë¶„ ê´€ë ¨ - ì •ê·œì‹ íŒ¨í„´
            "status": [
                r'ì˜ˆë¹„\s*í›„ë³´',
                r'ì¶œë§ˆ\s*ì˜ˆì •',
                r'[ê°€-í£]+ì´\s*ë˜ê² ìŠµë‹ˆë‹¤',  # "â—‹â—‹ì‹œì¥ì´ ë˜ê² ìŠµë‹ˆë‹¤"
            ],
            # ê³µì•½ì„± í‘œí˜„ (ì˜ˆë¹„í›„ë³´ ë“±ë¡ ì „ ì‚¬ì „ì„ ê±°ìš´ë™ ê¸ˆì§€)
            "pledge": [
                r'ê³µì•½ì„?\s*(ë°œí‘œ|ì œì‹œ|ë§ì”€)',
                r'ê³µì•½\s*ì‚¬í•­',
                r'ê³µì•½ì…ë‹ˆë‹¤',
                r'[0-9]+\s*ë²ˆì§¸\s*ê³µì•½',
                r'ì²«\s*ë²ˆì§¸\s*ê³µì•½',
                r'ë‘\s*ë²ˆì§¸\s*ê³µì•½',
                r'ì„¸\s*ë²ˆì§¸\s*ê³µì•½',
                r'ì œ\s*[0-9]+í˜¸\s*ê³µì•½',
                r'ì•½ì†\s*ë“œë¦½ë‹ˆë‹¤',
                r'ì•½ì†\s*ë“œë¦¬ê² ìŠµë‹ˆë‹¤',
                r'ì•½ì†\s*í•˜ê² ìŠµë‹ˆë‹¤',
                r'ì•½ì†í•©ë‹ˆë‹¤',
                r'ë°˜ë“œì‹œ\s*ì‹¤í˜„',
                r'ê¼­\s*ì‹¤í˜„',
                r'ë‹¹ì„ \s*ë˜ë©´',
                r'ë‹¹ì„ \s*í›„ì—?',
                r'ë‹¹ì„ ë˜ì–´',
                r'ì‹œì¥ì—\s*ë‹¹ì„ ',
                # ì •ì±… ì‹¤í–‰ ì˜ì§€ í‘œí˜„ (ê³µì•½ì„±)
                r'ì¶”ì§„í• \s*ê²ƒì…ë‹ˆë‹¤',
                r'ì¶”ì§„í•˜ê² ìŠµë‹ˆë‹¤',
                r'ì‹¤í˜„í•˜ê² ìŠµë‹ˆë‹¤',
                r'ë§Œë“¤ê² ìŠµë‹ˆë‹¤',
                r'í•´ë‚´ê² ìŠµë‹ˆë‹¤',
                r'ì´ë£¨ê² ìŠµë‹ˆë‹¤',
                r'ì „ê°œí•˜ê² ìŠµë‹ˆë‹¤',
                r'ì œê³µí•˜ê² ìŠµë‹ˆë‹¤',
                r'í™œì„±í™”í•˜ê² ìŠµë‹ˆë‹¤',
                r'ê°œì„ í•˜ê² ìŠµë‹ˆë‹¤',
                r'í™•ëŒ€í•˜ê² ìŠµë‹ˆë‹¤',
                r'ê°•í™”í•˜ê² ìŠµë‹ˆë‹¤',
                r'ì„¤ë¦½í•˜ê² ìŠµë‹ˆë‹¤',
                r'êµ¬ì¶•í•˜ê² ìŠµë‹ˆë‹¤',
                r'ë§ˆë ¨í•˜ê² ìŠµë‹ˆë‹¤',
                r'ì§€ì›í•˜ê² ìŠµë‹ˆë‹¤',
                r'í•´ê²°í•˜ê² ìŠµë‹ˆë‹¤',
                r'ë°”ê¾¸ê² ìŠµë‹ˆë‹¤',
                r'ë³€í™”ì‹œí‚¤ê² ìŠµë‹ˆë‹¤',
                r'ìœ ì¹˜í•˜ê² ìŠµë‹ˆë‹¤',
                r'ì—´ê² ìŠµë‹ˆë‹¤',
                r'ì‚´ë ¤ë‚´ê² ìŠµë‹ˆë‹¤',
                r'ì´ë¤„ë‚´ê² ìŠµë‹ˆë‹¤',
                r'ë°ë ¤ì˜¤ê² ìŠµë‹ˆë‹¤',
                r'ì°½ì¶œí•˜ê² ìŠµë‹ˆë‹¤',
                r'ì™„ì„±í•˜ê² ìŠµë‹ˆë‹¤',
                r'ì´ëŒê² ìŠµë‹ˆë‹¤',
                r'ê¸°ì—¬í•˜ê² ìŠµë‹ˆë‹¤',
                r'ë°”ì¹˜ê² ìŠµë‹ˆë‹¤',
                r'ìŸì•„ë¶“ê² ìŠµë‹ˆë‹¤',
            ],
            # ì§€ì§€ í˜¸ì†Œ
            "support": [
                r'ì§€ì§€í•´?\s*ì£¼ì‹­ì‹œì˜¤',
                r'ì§€ì§€ë¥¼?\s*ë¶€íƒ',
                r'ì§€ì§€ì™€\s*ì°¸ì—¬',
                r'í•¨ê»˜í•´?\s*ì£¼ì‹­ì‹œì˜¤',
                r'ì„ íƒí•´?\s*ì£¼ì‹­ì‹œì˜¤',
                r'ì§€ì›\s*ë¶€íƒ',
                r'íˆ¬í‘œí•´?\s*ì£¼ì‹­ì‹œì˜¤',
                r'í•œ\s*í‘œ\s*ë¶€íƒ',
                r'ë§¡ê²¨\s*ì£¼ì‹­ì‹œì˜¤',
                r'ë§¡ê²¨ì£¼ì‹­ì‹œì˜¤',
                r'ë§¡ê²¨\s*ì£¼ì‹­ì‹œ', # ì˜¤íƒ€ ëŒ€ì‘
                r'ë§¡ê²¨ì£¼ì‹­ì‹œ',   # ì˜¤íƒ€ ëŒ€ì‘
            ],
            # ì„ ê±° ì§ì ‘ ì–¸ê¸‰
            "election": [
                r'ë‹¤ìŒ\s*ì„ ê±°',
                r'[0-9]{4}ë…„\s*(ì§€ë°©)?ì„ ê±°',
                r'ì¬ì„ ì„?\s*ìœ„í•´',
                r'ì„ ê±°\s*ì¤€ë¹„',
                r'ì¶œë§ˆ\s*ì¤€ë¹„',
            ],
            # ğŸ”´ ê¸°ë¶€í–‰ìœ„ ê¸ˆì§€ (ì œ85ì¡° 6í•­) - ê¸ˆí’ˆ/í–¥ì‘ ì œê³µ ì•½ì†
            "bribery": [
                r'ìƒí’ˆê¶Œ.*?(ì§€ê¸‰|ì œê³µ|ë“œë¦¬)',
                r'ì„ ë¬¼.*?(ì§€ê¸‰|ì œê³µ|ë“œë¦¬)',
                r'ë¬¼í’ˆ.*?(ì§€ê¸‰|ì œê³µ|ë“œë¦¬)',
                r'ê¸ˆí’ˆ.*?(ì§€ê¸‰|ì œê³µ|ë“œë¦¬)',
                r'í˜„ê¸ˆ.*?(ì§€ê¸‰|ì œê³µ|ë“œë¦¬)',
                r'[0-9]+ë§Œ\s*ì›\s*(ì§€ê¸‰|ë“œë¦¬|ì œê³µ)',
                r'ì§€ì§€.*?ì„ ë¬¼',
                r'íˆ¬í‘œ.*?ì„ ë¬¼',
                r'ë¬´ìƒ\s*ì§€ê¸‰',
                r'ê²½í’ˆ',
                r'ì‚¬ì€í’ˆ',
                r'í˜œíƒ\s*ì œê³µ',
            ]
        },
        # ìë™ ì¹˜í™˜ ê·œì¹™ (forbidden â†’ replacement)
        "replacements": {
            'ê³µì•½': 'ì •ì±… ë°©í–¥',
            'ê³µì•½ì„ ë°œí‘œ': 'ì •ì±… ë°©í–¥ì„ ì œì•ˆ',
            'ê³µì•½ì„ ì œì‹œ': 'ì •ì±… ë°©í–¥ì„ ì œì•ˆ',
            'ê³µì•½ ì‚¬í•­': 'ì •ì±… ì œì•ˆ ì‚¬í•­',
            'ì²« ë²ˆì§¸ ê³µì•½': 'ì²« ë²ˆì§¸ ì •ì±… ì œì•ˆ',
            'ë‘ ë²ˆì§¸ ê³µì•½': 'ë‘ ë²ˆì§¸ ì •ì±… ì œì•ˆ',
            'ì„¸ ë²ˆì§¸ ê³µì•½': 'ì„¸ ë²ˆì§¸ ì •ì±… ì œì•ˆ',
            'ì œ1í˜¸ ê³µì•½': 'ì²« ë²ˆì§¸ ì •ì±… ì œì•ˆ',
            'ì œ2í˜¸ ê³µì•½': 'ë‘ ë²ˆì§¸ ì •ì±… ì œì•ˆ',
            'ì œ3í˜¸ ê³µì•½': 'ì„¸ ë²ˆì§¸ ì •ì±… ì œì•ˆ',
            # 'ì•½ì†ë“œë¦½ë‹ˆë‹¤' ê³„ì—´ì€ ë¦¬í„°ëŸ´ ì¹˜í™˜ ì‹œ ë¹„ë¬¸ ìƒì„± â†’ í”„ë¡¬í”„íŠ¸ ê°€ì´ë“œë¡œ ëŒ€ì²´
            'ë°˜ë“œì‹œ ì‹¤í˜„': 'ì‹¤í˜„ë  ìˆ˜ ìˆë„ë¡ ë…¸ë ¥',
            'ê¼­ ì‹¤í˜„': 'ì‹¤í˜„ë  ìˆ˜ ìˆë„ë¡ ë…¸ë ¥',
            'ë‹¹ì„ ë˜ë©´': 'ì´ ì •ì±…ì´ ì‹¤í˜„ëœë‹¤ë©´',
            'ë‹¹ì„  í›„': 'í–¥í›„',
            'ë‹¹ì„ ë˜ì–´': 'í˜ì„ ëª¨ì•„',
            'ì‹œì¥ì— ë‹¹ì„ ë˜ë©´': 'ì‹œì¥ìœ¼ë¡œì„œ í˜ì„ ëª¨ìœ¼ë©´',
            'ì§€ì§€í•´ ì£¼ì‹­ì‹œì˜¤': 'ê´€ì‹¬ ê°€ì ¸ ì£¼ì‹­ì‹œì˜¤',
            'ì§€ì§€ë¥¼ ë¶€íƒ': 'ê´€ì‹¬ì„ ë¶€íƒ',
            'ì§€ì§€ì™€ ì°¸ì—¬ë¥¼ ë¶€íƒ': 'ê´€ì‹¬ê³¼ ì„±ì›ì„ ë¶€íƒ',
            'ì§€ì§€ì™€ ì°¸ì—¬': 'ê´€ì‹¬ê³¼ ì„±ì›',
            'í•¨ê»˜í•´ ì£¼ì‹­ì‹œì˜¤': 'í•¨ê»˜ ê³ ë¯¼í•´ ì£¼ì‹­ì‹œì˜¤',
            'ì„ íƒí•´ ì£¼ì‹­ì‹œì˜¤': 'ê´€ì‹¬ ê°€ì ¸ ì£¼ì‹­ì‹œì˜¤',
            'íˆ¬í‘œí•´ ì£¼ì‹­ì‹œì˜¤': 'ê´€ì‹¬ ê°€ì ¸ ì£¼ì‹­ì‹œì˜¤',
            'ë‹¤ìŒ ì„ ê±°': 'ì•ìœ¼ë¡œ',
            'ì¬ì„ ì„ ìœ„í•´': 'ë” ë‚˜ì€ ì§€ì—­ì„ ìœ„í•´',
            'ì„ ê±° ì¤€ë¹„': 'ì •ì±… ì—°êµ¬',
            'ì¶œë§ˆ ì¤€ë¹„': 'ì •ì±… ì—°êµ¬',
            'ì˜ˆë¹„í›„ë³´': '',  # ì‚­ì œ
            'ì¶œë§ˆ ì˜ˆì •': 'ì •ì¹˜ í™œë™ ì¤‘ì¸',
            'ë§¡ê²¨ì£¼ì‹­ì‹œì˜¤': 'ê´€ì‹¬ ê°€ì ¸ ì£¼ì‹­ì‹œì˜¤',
            'ë§¡ê²¨ ì£¼ì‹­ì‹œì˜¤': 'ê´€ì‹¬ ê°€ì ¸ ì£¼ì‹­ì‹œì˜¤',
            'ë§¡ê²¨ì£¼ì‹­ì‹œ': 'ê´€ì‹¬ ê°€ì ¸ ì£¼ì‹­ì‹œì˜¤', # ì˜¤íƒ€ ëŒ€ì‘
            'ë§¡ê²¨ ì£¼ì‹­ì‹œ': 'ê´€ì‹¬ ê°€ì ¸ ì£¼ì‹­ì‹œì˜¤', # ì˜¤íƒ€ ëŒ€ì‘
            # ğŸ”§ ì§€ì§€ í˜¸ì†Œ í‘œí˜„ ì¶”ê°€
            'ì§€ì§€ì™€ ì„±ì›ì„ ë¶€íƒ': 'ê´€ì‹¬ì„ ë¶€íƒ',
            'ì§€ì§€ì™€ ì„±ì›': 'ê´€ì‹¬ê³¼ ì‘ì›',
            'ì„±ì›ì„ ë¶€íƒ': 'ê´€ì‹¬ì„ ë¶€íƒ',
            'ì„±ì› ë¶€íƒ': 'ê´€ì‹¬ ë¶€íƒ',
        },
        # í”„ë¡¬í”„íŠ¸ì— ì£¼ì…í•  ì§€ì‹œë¬¸
        "promptInstruction": """
[âš ï¸ ì„ ê±°ë²• ì¤€ìˆ˜ - ì˜ˆë¹„í›„ë³´ ë“±ë¡ ì´ì „ ë‹¨ê³„]
í˜„ì¬ ìƒíƒœì—ì„œëŠ” ì„ ê±°ë²•ìƒ ë‹¤ìŒ í‘œí˜„ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

** ğŸ”´ CRITICAL - í˜•ì‚¬ì²˜ë²Œ ëŒ€ìƒ **
âŒ ê¸°ë¶€í–‰ìœ„ ê¸ˆì§€ (ì œ85ì¡° 6í•­): "ìƒí’ˆê¶Œ ì§€ê¸‰", "ì„ ë¬¼ ì œê³µ", "00ë§Œì› ë“œë¦¬ê² ìŠµë‹ˆë‹¤"
âŒ í—ˆìœ„ì‚¬ì‹¤ê³µí‘œ (ì œ250ì¡°): ì¶œì²˜ ì—†ëŠ” í†µê³„/ìˆ˜ì¹˜ ì£¼ì¥, í™•ì¸ ì•ˆ ëœ ì‚¬ì‹¤
âŒ í›„ë³´ìë¹„ë°© (ì œ251ì¡°): "~ë¼ëŠ” ì†Œë¬¸", "~ë¼ê³  ë“¤ì—ˆìŠµë‹ˆë‹¤" í˜•íƒœì˜ ê°„ì ‘ì‚¬ì‹¤ ì ì‹œ

** ì ˆëŒ€ ê¸ˆì§€ í‘œí˜„ **
âŒ "ê³µì•½", "ê³µì•½ì„ ë°œí‘œí•©ë‹ˆë‹¤", "â—‹ë²ˆì§¸ ê³µì•½"
âŒ "ì•½ì†ë“œë¦½ë‹ˆë‹¤", "ì•½ì†í•˜ê² ìŠµë‹ˆë‹¤", "ë°˜ë“œì‹œ ì‹¤í˜„í•˜ê² ìŠµë‹ˆë‹¤"
âŒ "ë‹¹ì„ ë˜ë©´ â—‹â—‹í•˜ê² ìŠµë‹ˆë‹¤", "ë‹¹ì„  í›„ì—"
âŒ "ì§€ì§€í•´ ì£¼ì‹­ì‹œì˜¤", "í•¨ê»˜í•´ ì£¼ì‹­ì‹œì˜¤", "ì„ íƒí•´ ì£¼ì‹­ì‹œì˜¤"
âŒ "íˆ¬í‘œí•´ ì£¼ì‹­ì‹œì˜¤", "ì§€ì§€ë¥¼ ë¶€íƒë“œë¦½ë‹ˆë‹¤"
âŒ "ë‹¤ìŒ ì„ ê±°ì—ì„œ", "2026ë…„ ì§€ë°©ì„ ê±°ì—ì„œ", "ì¬ì„ ì„ ìœ„í•´"
âŒ "ì˜ˆë¹„í›„ë³´", "í›„ë³´", "ì¶œë§ˆ ì˜ˆì •ì"
âŒ "ë°”ê¿‰ë‹ˆë‹¤", "ë§Œë“­ë‹ˆë‹¤", "í•´ê²°í•©ë‹ˆë‹¤" (ë‹¨ì •ì  ê³µì•½ í‘œí˜„)
âŒ "~í•˜ê² ìŠµë‹ˆë‹¤" í˜•íƒœì˜ ëª¨ë“  ê³µì•½ì„± í‘œí˜„

** ëŒ€ì²´ í‘œí˜„ ê°€ì´ë“œ **
âœ… "ê³µì•½" â†’ "ì •ì±… ë°©í–¥", "ë¹„ì „", "ì •ì±… ì œì•ˆ"
âœ… "ë‹¹ì„ ë˜ë©´" â†’ "ì´ ì •ì±…ì´ ì‹¤í˜„ëœë‹¤ë©´"
âœ… "ì§€ì§€ ë¶€íƒ" â†’ "ê´€ì‹¬ ë¶€íƒë“œë¦½ë‹ˆë‹¤"
âœ… "ë°”ê¾¸ê² ìŠµë‹ˆë‹¤" â†’ "ë³€í™”ê°€ í•„ìš”í•©ë‹ˆë‹¤", "ê°œì„ ì„ ì œì•ˆí•©ë‹ˆë‹¤"
âœ… "ë§¡ê²¨ì£¼ì‹­ì‹œì˜¤" â†’ "ê´€ì‹¬ ê°€ì ¸ ì£¼ì‹­ì‹œì˜¤"

** "ì•½ì†" í‘œí˜„ ëŒ€ì²´ ê°€ì´ë“œ (ì¤‘ìš”!) **
"ì•½ì†ë“œë¦½ë‹ˆë‹¤", "ì•½ì†í•˜ê² ìŠµë‹ˆë‹¤" ë“±ì˜ í‘œí˜„ì€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.
ëŒ€ì‹  ë¬¸ë§¥ì— ë§ê²Œ ì¤‘ë¦½ì ì¸ ë°©í–¥ ì œì‹œ í‘œí˜„ì„ ì‚¬ìš©í•˜ì„¸ìš”:
- "~ì„ ì•½ì†ë“œë¦½ë‹ˆë‹¤" â†’ "~ì„ ê²€í† í•´ ë³´ê² ìŠµë‹ˆë‹¤", "~ì´ í•„ìš”í•©ë‹ˆë‹¤"
- "~í•  ê²ƒì„ ì•½ì†ë“œë¦½ë‹ˆë‹¤" â†’ "~ì„ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤", "~ì„ ì œì•ˆí•©ë‹ˆë‹¤"
- "ë°˜ë“œì‹œ ~í•˜ê² ë‹¤ê³  ì•½ì†ë“œë¦½ë‹ˆë‹¤" â†’ "~ì„ ê³„ì† ì ê²€í•´ ë³´ê² ìŠµë‹ˆë‹¤"

** ìˆ˜ì¹˜/í†µê³„ ì‚¬ìš© ì‹œ í•„ìˆ˜ **
âœ… ë°˜ë“œì‹œ ì¶œì²˜ ëª…ì‹œ: "[ì¶œì²˜: í†µê³„ì²­ 2024]", "[ì¶œì²˜: ë¶€ì‚°ì‹œ ìë£Œ]"
âŒ ì¶œì²˜ ì—†ëŠ” ìˆ˜ì¹˜ ì‚¬ìš© ê¸ˆì§€

** [CRITICAL] ê¸ˆì§€ì–´ íšŒí”¼ ê¼¼ìˆ˜ ì ˆëŒ€ ê¸ˆì§€ **
âŒ ê¸ˆì§€ì–´ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ê³ ì˜ë¡œ ì˜¤íƒ€ë¥¼ ë‚´ê±°ë‚˜ ë¬¸ì¥ì„ ìë¥´ëŠ” í–‰ìœ„ ì ˆëŒ€ ê¸ˆì§€.
   - ì˜ˆ: "ë§¡ê²¨ì£¼ì‹­ì‹œ" (X), "ì•½ì†í•˜ê² ìŠµ" (X), "íˆ¬í‘œí•´ì£¼ì‹­" (X)
âœ… ë°˜ë“œì‹œ ì™„ì„±ëœ ë¬¸ì¥ê³¼ ì˜¬ë°”ë¥¸ ì¢…ê²° ì–´ë¯¸ë¥¼ ì‚¬ìš©í•˜ê³ , ê¸ˆì§€ì–´ëŠ” 'í—ˆìš©ëœ ëŒ€ì²´ í‘œí˜„'ìœ¼ë¡œ ì˜ë¯¸ë§Œ ì „ë‹¬í•˜ì‹­ì‹œì˜¤.

** ì‚¬ìš© ê°€ëŠ¥í•œ í‘œí˜„ ì˜ˆì‹œ **
"ì •ì±… ë°©í–¥ì„ ì œì•ˆí•©ë‹ˆë‹¤"
"ë¹„ì „ì„ ê³µìœ ë“œë¦½ë‹ˆë‹¤"
"ì´ëŸ° ë°©í–¥ì˜ ì •ì±…ì„ ì—°êµ¬í•˜ê³  ìˆìŠµë‹ˆë‹¤"
"ë…¼ì˜ë¥¼ ì´ì–´ê°‘ë‹ˆë‹¤"

âš ï¸ **[ì¤‘ìš”] ë‹¨ìˆœ ë‹¨ì–´ ì¹˜í™˜ ê¸ˆì§€ (ì¡°ì‚¬ ì¤‘ë³µ ë°©ì§€)**
- "ë¶€ì‚°ì„ ë§Œë“¤ê² ìŠµë‹ˆë‹¤" â†’ "ë¶€ì‚°ì„ ì„ ì œì•ˆí•©ë‹ˆë‹¤" (X) ì²˜ëŸ¼ ì¡°ì‚¬ê°€ ì¤‘ë³µë˜ì§€ ì•Šê²Œ ì£¼ì˜í•˜ì„¸ìš”.
- ë¬¸ì¥ ì „ì²´ì˜ êµ¬ì¡°ë¥¼ ë°”ê¿”ì„œ ìì—°ìŠ¤ëŸ½ê²Œ ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤.
- ì˜ˆ: "í”Œë«í¼ì„ êµ¬ì¶•í•˜ê² ìŠµë‹ˆë‹¤" â†’ "í”Œë«í¼ êµ¬ì¶•ì„ ì œì•ˆí•©ë‹ˆë‹¤" (O)

** âœ… í›„ì› ê´€ë ¨ ì •ë³´ ë³´ì¡´ (ì •ì¹˜ìê¸ˆë²•ìƒ í•©ë²•) **
í›„ì›íšŒ ê³„ì¢Œ ì•ˆë‚´ëŠ” ì •ì¹˜ìê¸ˆë²•ì— ë”°ë¼ í•©ë²•ì´ë¯€ë¡œ ë‹¤ìŒ ì •ë³´ëŠ” ê·¸ëŒ€ë¡œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤:
- í›„ì›íšŒ ê³„ì¢Œë²ˆí˜¸, ì˜ˆê¸ˆì£¼, ë¬¸ì ì—°ë½ì²˜
- í›„ì›ê¸ˆ ì˜ìˆ˜ì¦ ë°œê¸‰ ì•ˆë‚´
- "í•¨ê»˜í•´ ì£¼ì‹­ì‹œì˜¤" í‘œí˜„ (í›„ì› ìš”ì²­ ë§¥ë½ì—ì„œ í—ˆìš©)
- "ì§€ê¸ˆ ë°”ë¡œ í•¨ê»˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤" ë“± ì°¸ì—¬ ìœ ë„ ë¬¸êµ¬
âš ï¸ ë‹¨, "íˆ¬í‘œí•´ ì£¼ì‹­ì‹œì˜¤", "ì§€ì§€í•´ ì£¼ì‹­ì‹œì˜¤"ëŠ” ì—¬ì „íˆ ê¸ˆì§€ì…ë‹ˆë‹¤.
"""
    },

    # 2ë‹¨ê³„: ì˜ˆë¹„í›„ë³´ ë“±ë¡ ì´í›„
    "STAGE_2": {
        "applies_to": ['ì˜ˆë¹„'],
        "description": 'ì˜ˆë¹„í›„ë³´ ë“±ë¡ ì´í›„ - ì„ ê´€ìœ„ ë“±ë¡ ì™„ë£Œ',
        "forbidden": {
            # ë³¸í›„ë³´ ì „ìš© í‘œí˜„ë§Œ ê¸ˆì§€
            "fullCandidateOnly": [
                r'íˆ¬í‘œí•´?\s*ì£¼ì‹­ì‹œì˜¤',
                r'ì €ë¥¼\s*ì„ íƒí•´?\s*ì£¼ì‹­ì‹œì˜¤',
                r'ê¸°í˜¸\s*[0-9]+ë²ˆ',  # ì•„ì§ ê¸°í˜¸ ì—†ìŒ
            ]
        },
        "replacements": {
            'íˆ¬í‘œí•´ ì£¼ì‹­ì‹œì˜¤': 'ê´€ì‹¬ì„ ë¶€íƒë“œë¦½ë‹ˆë‹¤',
            'ì €ë¥¼ ì„ íƒí•´ ì£¼ì‹­ì‹œì˜¤': 'ì˜ê²¬ì„ ë¶€íƒë“œë¦½ë‹ˆë‹¤',
        },
        "promptInstruction": """
[ì„ ê±°ë²• ì¤€ìˆ˜ - ì˜ˆë¹„í›„ë³´ ë‹¨ê³„]
ì˜ˆë¹„í›„ë³´ ë‹¨ê³„ì—ì„œë„ ê³µì•½ì„± í‘œí˜„ê³¼ ì„ ê±°ìš´ë™ì„± ìš”ì²­ì€ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

âœ… ì‚¬ìš© ê°€ëŠ¥: "ì •ì±… ë°©í–¥", "ë¹„ì „ ê³µìœ ", "ê²€í† í•´ ë³´ê² ìŠµë‹ˆë‹¤", "í•„ìš”í•©ë‹ˆë‹¤"
âŒ ì‚¬ìš© ê¸ˆì§€: "ê³µì•½", "ì•½ì†ë“œë¦½ë‹ˆë‹¤", "ë‹¹ì„ ë˜ë©´", "ì§€ì§€í•´ ì£¼ì‹­ì‹œì˜¤", "íˆ¬í‘œí•´ ì£¼ì‹­ì‹œì˜¤"
"""
    },

    # 3ë‹¨ê³„: ë³¸ í›„ë³´ ë“±ë¡ ì´í›„ (ì„ ê±°ê¸°ê°„)
    "STAGE_3": {
        "applies_to": ['í›„ë³´'],
        "description": 'ë³¸ í›„ë³´ ë“±ë¡ ì´í›„ - ì„ ê±°ê¸°ê°„',
        "forbidden": {
            # ë¶ˆë²• í‘œí˜„ë§Œ ê¸ˆì§€
            "illegal": [
                r'ê¸ˆí’ˆ',
                r'í–¥ì‘',
                r'ëˆì„?\s*ë“œë¦¬',
            ]
        },
        "replacements": {},
        "promptInstruction": """
[ì„ ê±°ë²• ì¤€ìˆ˜ - ì •ì‹ í›„ë³´ ë‹¨ê³„]
ëŒ€ë¶€ë¶„ì˜ ì„ ê±°ìš´ë™ í‘œí˜„ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
âŒ ê¸ˆì§€: ê¸ˆí’ˆ/í–¥ì‘ ì œê³µ ì•”ì‹œ, í—ˆìœ„ì‚¬ì‹¤ ìœ í¬
"""
    }
}


def get_election_stage(status: str) -> Dict[str, Any]:
    """
    ìƒíƒœì— í•´ë‹¹í•˜ëŠ” ì„ ê±°ë²• ë‹¨ê³„ ë°˜í™˜

    Args:
        status: ì‚¬ìš©ì ìƒíƒœ (ì¤€ë¹„/í˜„ì—­/ì˜ˆë¹„/í›„ë³´/active)

    Returns:
        í•´ë‹¹ ë‹¨ê³„ì˜ ê·œì¹™ ë”•ì…”ë„ˆë¦¬
    """
    for stage_name, stage in ELECTION_EXPRESSION_RULES.items():
        if stage.get("applies_to") and status in stage["applies_to"]:
            stage_copy = stage.copy()
            stage_copy['name'] = stage_name
            return stage_copy

    # Default to STAGE_1 if unknown
    default_stage = ELECTION_EXPRESSION_RULES['STAGE_1'].copy()
    default_stage['name'] = 'STAGE_1'
    return default_stage


def get_all_forbidden_patterns(status: str) -> List[str]:
    """
    í•´ë‹¹ ë‹¨ê³„ì˜ ëª¨ë“  ê¸ˆì§€ íŒ¨í„´ì„ í”Œë«í•˜ê²Œ ë°˜í™˜

    Args:
        status: ì‚¬ìš©ì ìƒíƒœ

    Returns:
        ì •ê·œì‹ íŒ¨í„´ ë¬¸ìì—´ ë¦¬ìŠ¤íŠ¸
    """
    stage = get_election_stage(status)
    forbidden = stage.get('forbidden', {})

    patterns = []
    for category, pattern_list in forbidden.items():
        if isinstance(pattern_list, list):
            patterns.extend(pattern_list)

    return patterns


def validate_election_content(content: str, status: str) -> Dict[str, Any]:
    """
    ì½˜í…ì¸ ì—ì„œ ì„ ê±°ë²• ìœ„ë°˜ í‘œí˜„ ê²€ì¶œ

    Args:
        content: ê²€ì‚¬í•  ì½˜í…ì¸ 
        status: ì‚¬ìš©ì ìƒíƒœ

    Returns:
        {
            'passed': bool,
            'violations': [{'pattern': str, 'category': str, 'matches': list, 'severity': str}],
            'total_violations': int
        }
    """
    stage = get_election_stage(status)
    forbidden = stage.get('forbidden', {})

    violations = []

    # ì¹´í…Œê³ ë¦¬ë³„ ì‹¬ê°ë„ ë§¤í•‘
    severity_map = {
        'bribery': 'critical',      # ê¸°ë¶€í–‰ìœ„ - í˜•ì‚¬ì²˜ë²Œ
        'status': 'high',
        'pledge': 'high',
        'support': 'high',
        'election': 'medium',
        'fullCandidateOnly': 'high',
        'illegal': 'critical',
    }

    for category, patterns in forbidden.items():
        if not isinstance(patterns, list):
            continue

        for pattern in patterns:
            try:
                matches = re.findall(pattern, content, re.IGNORECASE)
                if matches:
                    violations.append({
                        'pattern': pattern,
                        'category': category,
                        'matches': matches if isinstance(matches[0], str) else [m[0] if isinstance(m, tuple) else m for m in matches],
                        'severity': severity_map.get(category, 'medium'),
                        'count': len(matches)
                    })
            except re.error as e:
                print(f"âš ï¸ ì •ê·œì‹ ì˜¤ë¥˜: {pattern} - {e}")
                continue

    return {
        'passed': len(violations) == 0,
        'violations': violations,
        'total_violations': sum(v['count'] for v in violations)
    }


def sanitize_election_content(content: str, status: str, context_intent: str = None) -> Dict[str, Any]:
    """
    ì½˜í…ì¸ ì—ì„œ ì„ ê±°ë²• ìœ„ë°˜ í‘œí˜„ì„ ìë™ ì¹˜í™˜

    Args:
        content: ì›ë³¸ ì½˜í…ì¸ 
        status: ì‚¬ìš©ì ìƒíƒœ
        context_intent: ê¸€ì˜ ì˜ë„ (donation_requestì¸ ê²½ìš° ì¼ë¶€ ì¹˜í™˜ ìŠ¤í‚µ)

    Returns:
        {
            'sanitized_content': str,
            'replacements_made': int,
            'replacement_log': [{'original': str, 'replacement': str}]
        }
    """
    stage = get_election_stage(status)
    replacements = stage.get('replacements', {}).copy()  # ì›ë³¸ ìˆ˜ì • ë°©ì§€ë¥¼ ìœ„í•´ ë³µì‚¬

    # ğŸ”´ [NEW] í›„ì› ìš”ì²­ ë§¥ë½ì—ì„œëŠ” "í•¨ê»˜í•´ ì£¼ì‹­ì‹œì˜¤" ì¹˜í™˜ ìŠ¤í‚µ
    if context_intent == 'donation_request':
        skip_patterns = [
            'í•¨ê»˜í•´ ì£¼ì‹­ì‹œì˜¤',
            'í•¨ê»˜í•´ì£¼ì‹­ì‹œì˜¤',
        ]
        for pattern in skip_patterns:
            if pattern in replacements:
                del replacements[pattern]
        print(f"ğŸ’° [ì„ ê±°ë²•] í›„ì› ìš”ì²­ ë§¥ë½ ê°ì§€ - 'í•¨ê»˜í•´ ì£¼ì‹­ì‹œì˜¤' ì¹˜í™˜ ìŠ¤í‚µ")

    # ğŸ”´ [NEW] ë”°ì˜´í‘œë¡œ ë¬¶ì¸ ë¬¸ì¥ ë³´ì¡´ (Bio ì¸ìš©ë¬¸ ë³´í˜¸)
    import re
    quote_pattern = r'"([^"]+)"'
    quoted_texts = re.findall(quote_pattern, content)
    
    # ë”°ì˜´í‘œ ë¬¸ì¥ì„ ì„ì‹œ í† í°ìœ¼ë¡œ ì¹˜í™˜
    temp_content = content
    for i, q in enumerate(quoted_texts):
        temp_content = temp_content.replace(f'"{q}"', f'__PRESERVED_QUOTE_{i}__')
    
    if quoted_texts:
        print(f"ğŸ”’ [ì„ ê±°ë²•] {len(quoted_texts)}ê°œ ë”°ì˜´í‘œ ë¬¸ì¥ ë³´ì¡´ ì²˜ë¦¬")

    sanitized = temp_content
    replacement_log = []
    replacements_made = 0

    # ê¸´ íŒ¨í„´ë¶€í„° ì¹˜í™˜ (ë” êµ¬ì²´ì ì¸ ê²ƒ ìš°ì„ )
    sorted_replacements = sorted(replacements.items(), key=lambda x: len(x[0]), reverse=True)

    for original, replacement in sorted_replacements:
        if original in sanitized:
            count = sanitized.count(original)
            sanitized = sanitized.replace(original, replacement)
            replacements_made += count
            replacement_log.append({
                'original': original,
                'replacement': replacement,
                'count': count
            })

    # ğŸ”´ [NEW] ë”°ì˜´í‘œ ë¬¸ì¥ ë³µì›
    for i, q in enumerate(quoted_texts):
        sanitized = sanitized.replace(f'__PRESERVED_QUOTE_{i}__', f'"{q}"')

    return {
        'sanitized_content': sanitized,
        'replacements_made': replacements_made,
        'replacement_log': replacement_log
    }


def get_prompt_instruction(status: str) -> str:
    """
    í•´ë‹¹ ë‹¨ê³„ì˜ í”„ë¡¬í”„íŠ¸ ì§€ì‹œë¬¸ ë°˜í™˜

    Args:
        status: ì‚¬ìš©ì ìƒíƒœ

    Returns:
        í”„ë¡¬í”„íŠ¸ì— ì‚½ì…í•  ì„ ê±°ë²• ì¤€ìˆ˜ ì§€ì‹œë¬¸
    """
    stage = get_election_stage(status)
    return stage.get('promptInstruction', '')


# í¸ì˜ í•¨ìˆ˜: ìœ„ë°˜ ì—¬ë¶€ë§Œ ë¹ ë¥´ê²Œ í™•ì¸
def has_election_violations(content: str, status: str) -> bool:
    """ì½˜í…ì¸ ì— ì„ ê±°ë²• ìœ„ë°˜ì´ ìˆëŠ”ì§€ ë¹ ë¥´ê²Œ í™•ì¸"""
    result = validate_election_content(content, status)
    return not result['passed']


# í¸ì˜ í•¨ìˆ˜: ìœ„ë°˜ ë‚´ìš©ì„ ì‚¬ëŒì´ ì½ê¸° ì‰¬ìš´ í˜•íƒœë¡œ ë°˜í™˜
def get_violation_summary(content: str, status: str) -> str:
    """ìœ„ë°˜ ë‚´ìš© ìš”ì•½ ë¬¸ìì—´ ë°˜í™˜"""
    result = validate_election_content(content, status)

    if result['passed']:
        return "ì„ ê±°ë²• ìœ„ë°˜ í‘œí˜„ ì—†ìŒ"

    lines = [f"âš ï¸ ì´ {result['total_violations']}ê±´ì˜ ì„ ê±°ë²• ìœ„ë°˜ í‘œí˜„ ê°ì§€:"]

    for v in result['violations']:
        severity_emoji = {'critical': 'ğŸ”´', 'high': 'ğŸŸ ', 'medium': 'ğŸŸ¡'}.get(v['severity'], 'âšª')
        lines.append(f"  {severity_emoji} [{v['category']}] \"{', '.join(v['matches'][:3])}\" ({v['count']}íšŒ)")

    return '\n'.join(lines)
