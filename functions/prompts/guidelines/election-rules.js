// functions/prompts/guidelines/election-rules.js
// 선거법 준수 표현 규칙 및 유틸리티 (Pure Logic Only)
'use strict';

// ============================================================================
// 선거법 준수 표현 규칙 (3단계)
// 1단계: 예비후보 등록 이전 (준비, 현역)
// 2단계: 예비후보 등록 이후 (예비)
// 3단계: 본 후보 등록 이후 (후보)
// ============================================================================

const ELECTION_EXPRESSION_RULES = {
    // 1단계: 예비후보 등록 이전
    STAGE_1: {
        applies_to: ['준비', '현역'],
        description: '예비후보 등록 이전 - 일반 정치인, 당직자, 현역 의원/단체장',
        forbidden: {
            // 신분 관련 - 정규식 패턴
            status: [
                /예비\s*후보/g,
                /출마\s*예정/g,
                /[가-힣]+이\s*되겠습니다/g,  // "○○시장이 되겠습니다"
            ],
            // 공약성 표현 (예비후보 등록 전 사전선거운동 금지)
            pledge: [
                /공약을?\s*(발표|제시|말씀)/g,
                /공약\s*사항/g,
                /공약입니다/g,
                /[0-9]+\s*번째\s*공약/g,
                /첫\s*번째\s*공약/g,
                /두\s*번째\s*공약/g,
                /세\s*번째\s*공약/g,
                /약속\s*드립니다/g,
                /약속\s*드리겠습니다/g,
                /약속\s*하겠습니다/g,
                /반드시\s*실현/g,
                /꼭\s*실현/g,
                /당선\s*되면/g,
                /당선\s*후에?/g,
                /당선되어/g,
                // 정책 실행 의지 표현 (공약성)
                /추진할\s*것입니다/g,
                /추진하겠습니다/g,
                /실현하겠습니다/g,
                /만들겠습니다/g,
                /해내겠습니다/g,
                /이루겠습니다/g,
                /전개하겠습니다/g,
                /제공하겠습니다/g,
                /활성화하겠습니다/g,
                /개선하겠습니다/g,
                /확대하겠습니다/g,
                /강화하겠습니다/g,
                /설립하겠습니다/g,
                /구축하겠습니다/g,
                /마련하겠습니다/g,
                /지원하겠습니다/g,
                /해결하겠습니다/g,
                /바꾸겠습니다/g,
                /변화시키겠습니다/g,
            ],
            // 지지 호소
            support: [
                /지지해?\s*주십시오/g,
                /지지를?\s*부탁/g,
                /지지와\s*참여/g,
                /함께해?\s*주십시오/g,
                /선택해?\s*주십시오/g,
                /지원\s*부탁/g,
                /투표해?\s*주십시오/g,
                /한\s*표\s*부탁/g,
            ],
            // 선거 직접 언급
            election: [
                /다음\s*선거/g,
                /[0-9]{4}년\s*(지방)?선거/g,
                /재선을?\s*위해/g,
                /선거\s*준비/g,
                /출마\s*준비/g,
            ],
            // 🔴 기부행위 금지 (제85조 6항) - 금품/향응 제공 약속
            bribery: [
                /상품권.*?(지급|제공|드리)/g,
                /선물.*?(지급|제공|드리)/g,
                /물품.*?(지급|제공|드리)/g,
                /금품.*?(지급|제공|드리)/g,
                /현금.*?(지급|제공|드리)/g,
                /[0-9]+만\s*원\s*(지급|드리|제공)/g,
                /지지.*?선물/g,
                /투표.*?선물/g,
                /무상\s*지급/g,
                /경품/g,
                /사은품/g,
                /혜택\s*제공/g,
            ]
        },
        // 자동 치환 규칙 (forbidden → replacement)
        replacements: {
            '공약': '정책 방향',
            '공약을 발표': '정책 방향을 제안',
            '공약을 제시': '정책 방향을 제안',
            '공약 사항': '정책 제안 사항',
            '첫 번째 공약': '첫 번째 정책 제안',
            '두 번째 공약': '두 번째 정책 제안',
            '세 번째 공약': '세 번째 정책 제안',
            // '약속드립니다' 계열은 리터럴 치환 시 비문 생성 → 프롬프트 가이드로 대체
            '반드시 실현': '실현될 수 있도록 노력',
            '꼭 실현': '실현될 수 있도록 노력',
            '당선되면': '이 정책이 실현된다면',
            '당선 후': '향후',
            '당선되어': '힘을 모아',
            '지지해 주십시오': '관심 가져 주십시오',
            '지지를 부탁': '관심을 부탁',
            '지지와 참여를 부탁': '관심과 성원을 부탁',
            '지지와 참여': '관심과 성원',
            '함께해 주십시오': '함께 고민해 주십시오',
            '선택해 주십시오': '관심 가져 주십시오',
            '투표해 주십시오': '관심 가져 주십시오',
            '다음 선거': '앞으로',
            '재선을 위해': '더 나은 지역을 위해',
            '선거 준비': '정책 연구',
            '출마 준비': '정책 연구',
            '예비후보': '',  // 삭제
            '출마 예정': '정치 활동 중인',

            // 🔧 지지 호소 표현 추가
            '지지와 성원을 부탁': '관심을 부탁',
            '지지와 성원': '관심과 응원',
            '성원을 부탁': '관심을 부탁',
            '성원 부탁': '관심 부탁',
        },
        // 프롬프트에 주입할 지시문
        promptInstruction: `
[⚠️ 선거법 준수 - 예비후보 등록 이전 단계]
현재 상태에서는 선거법상 다음 표현을 사용할 수 없습니다.

** 🔴 CRITICAL - 형사처벌 대상 **
❌ 기부행위 금지 (제85조 6항): "상품권 지급", "선물 제공", "00만원 드리겠습니다"
❌ 허위사실공표 (제250조): 출처 없는 통계/수치 주장, 확인 안 된 사실
❌ 후보자비방 (제251조): "~라는 소문", "~라고 들었습니다" 형태의 간접사실 적시

** 절대 금지 표현 **
❌ "공약", "공약을 발표합니다", "○번째 공약"
❌ "약속드립니다", "약속하겠습니다", "반드시 실현하겠습니다"
❌ "당선되면 ○○하겠습니다", "당선 후에"
❌ "지지해 주십시오", "함께해 주십시오", "선택해 주십시오"
❌ "투표해 주십시오", "지지를 부탁드립니다"
❌ "다음 선거에서", "2026년 지방선거에서", "재선을 위해"
❌ "예비후보", "후보", "출마 예정자"
❌ "바꿉니다", "만듭니다", "해결합니다" (단정적 공약 표현)

** 대체 표현 가이드 **
✅ "공약" → "정책 방향", "비전", "정책 제안"
✅ "당선되면" → "이 정책이 실현된다면"
✅ "지지 부탁" → "관심 부탁드립니다"
✅ "바꾸겠습니다" → "변화가 필요합니다", "개선을 제안합니다"

** "약속" 표현 대체 가이드 (중요!) **
"약속드립니다", "약속하겠습니다" 등의 표현은 사용하지 마세요.
대신 문맥에 맞게 중립적인 방향 제시 표현을 사용하세요:
- "~을 약속드립니다" → "~을 검토해 보겠습니다", "~이 필요합니다"
- "~할 것을 약속드립니다" → "~을 살펴보겠습니다", "~을 제안합니다"
- "반드시 ~하겠다고 약속드립니다" → "~을 계속 점검해 보겠습니다"

** 수치/통계 사용 시 필수 **
✅ 반드시 출처 명시: "[출처: 통계청 2024]", "[출처: 부산시 자료]"
❌ 출처 없는 수치 사용 금지

** 사용 가능한 표현 예시 **
"정책 방향을 제안합니다"
"비전을 공유드립니다"
"이런 방향의 정책을 연구하고 있습니다"
"논의를 이어갑니다"

⚠️ **[중요] 단순 단어 치환 금지 (조사 중복 방지)**
- "부산을 만들겠습니다" → "부산을 을 제안합니다" (X) 처럼 조사가 중복되지 않게 주의하세요.
- 문장 전체의 구조를 바꿔서 자연스럽게 수정해야 합니다.
- 예: "플랫폼을 구축하겠습니다" → "플랫폼 구축을 제안합니다" (O)
`
    },

    // 2단계: 예비후보 등록 이후
    STAGE_2: {
        applies_to: ['예비'],
        description: '예비후보 등록 이후 - 선관위 등록 완료',
        forbidden: {
            // 본후보 전용 표현만 금지
            fullCandidateOnly: [
                /투표해?\s*주십시오/g,
                /저를\s*선택해?\s*주십시오/g,
                /기호\s*[0-9]+번/g,  // 아직 기호 없음
            ]
        },
        replacements: {
            '투표해 주십시오': '관심을 부탁드립니다',
            '저를 선택해 주십시오': '의견을 부탁드립니다',
        },
        promptInstruction: `
[선거법 준수 - 예비후보 단계]
예비후보 단계에서도 공약성 표현과 선거운동성 요청은 사용하지 않습니다.

✅ 사용 가능: "정책 방향", "비전 공유", "검토해 보겠습니다", "필요합니다"
❌ 사용 금지: "공약", "약속드립니다", "당선되면", "지지해 주십시오", "투표해 주십시오"
`
    },

    // 3단계: 본 후보 등록 이후 (선거기간)
    STAGE_3: {
        applies_to: ['후보'],
        description: '본 후보 등록 이후 - 선거기간',
        forbidden: {
            // 불법 표현만 금지
            illegal: [
                /금품/g,
                /향응/g,
                /돈을?\s*드리/g,
            ]
        },
        replacements: {},
        promptInstruction: `
[선거법 준수 - 정식 후보 단계]
대부분의 선거운동 표현이 가능합니다.
❌ 금지: 금품/향응 제공 암시, 허위사실 유포
`
    }
};

/**
 * 상태에 해당하는 선거법 단계 반환
 * @param {string} status - 사용자 상태 (준비/현역/예비/후보)
 * @returns {Object|null} 해당 단계의 규칙
 */
function getElectionStage(status) {
    for (const [stageName, stage] of Object.entries(ELECTION_EXPRESSION_RULES)) {
        if (stage.applies_to && stage.applies_to.includes(status)) {
            return { name: stageName, ...stage };
        }
    }
    return null;
}

module.exports = {
    ELECTION_EXPRESSION_RULES,
    getElectionStage
};
